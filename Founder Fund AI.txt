<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Founders Fund — Time‑Weighted Split Calculator (PGP enabled, AI-enhanced)</title>
<style>
  :root{--bg:#0b0e14;--panel:#121720;--text:#e6edf3;--muted:#9aa4b2;--accent:#39d0d8;--warn:#ffb020;--bad:#ff6b6b;--good:#35c759;--line:#233047;--ink:#0f141c}
  html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:0}
  .wrap{max-width:1240px;margin:18px auto;padding:0 14px}
  .status{background:#0f141c;border:1px solid #223047;border-radius:10px;padding:10px 12px;margin-bottom:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .status .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
  .dot.ok{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
  h1{font-size:24px;margin:8px 0 12px;text-align:center}
  h2{font-size:18px;margin:16px 0 10px;color:#d7e0ea}
  .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .tab{background:#172133;border:1px solid #283753;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:600;color:#cfe2ff}
  .tab.active{background:#1b2433;color:#fff}
  .panel{background:var(--panel);border:1px solid #1f2937;border-radius:10px;padding:16px;margin:12px 0}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;align-items:end}
  label{font-size:12px;color:var(--muted)}
  input[type="number"],input[type="text"],input[type="date"],select, textarea{width:100%;background:#0f141c;color:#e6edf3;border:1px solid #263043;padding:9px 10px;border-radius:8px;font-size:14px;font-family:system-ui}
  .btn{background:#172133;color:#e6edf3;border:1px solid #283753;padding:9px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn:hover{border-color:#33507a}
  .small{font-size:12px;color:#cbd5e1}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #334155;color:#cbd5e1;margin:4px 8px 0 0}
  .tablewrap{width:100%;overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:14px;min-width:980px}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);vertical-align:top}
  th{color:#b6c2d1;font-weight:600;text-align:left;white-space:nowrap}
  .right{text-align:right;white-space:nowrap}
  .x{cursor:pointer;color:#8ab4ff}
  .namecell{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .badge{font-size:11px;border:1px solid #334155;border-radius:999px;padding:1px 6px;color:#cbd5e1}
  .warnbox{border:1px solid #635015;background:#2b2315;color:#f6e4b4;border-radius:8px;padding:8px 10px;margin-top:8px}
  .legend{margin-top:6px;display:flex;gap:12px;flex-wrap:wrap}
  .lg{display:inline-flex;align-items:center;gap:6px}
  .sw{width:12px;height:12px;border-radius:2px;display:inline-block}
  canvas{background:#0f141c;border:1px solid #253347;border-radius:8px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  @media (max-width: 720px){h1{font-size:20px} table{min-width:920px} .grid{grid-template-columns:repeat(6,1fr)}}
</style>
<!-- External libraries for OCR and PDF export -->
<script src="https://unpkg.com/tesseract.js@v6.0.0/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.3/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="status">
    <span class="dot ok"></span><b>Calculator ready.</b>
    <span id="seedMsg" class="small">Seeding defaults…</span>
    <button class="btn" id="btnReseed">Force re‑seed</button>
    <button class="btn" id="btnRecalcTop">Recalculate</button>
    <label class="small"><input type="checkbox" id="autoSave" checked> Auto‑save on Recalculate</label>
    <button class="btn" id="btnSaveSnap">Save snapshot now</button>
    <span class="small" id="calcTime"></span>
  </div>

  <h1>Founders Fund</h1>

  <div class="tabs">
    <div class="tab active" data-tab="calc">Calculator</div>
    <div class="tab" data-tab="history">History</div>
    <div class="tab" data-tab="charts">Charts</div>
    <div class="tab" data-tab="audit">Founders Audit</div>
    <div class="tab" data-tab="assistant">AI Assistant</div>
  </div>

  <!-- ===== CALCULATOR ===== -->
  <div class="panel" data-pane="calc">
    <h2>Allocation Settings</h2>
    <div class="grid">
      <div style="grid-column:span 3">
        <label>View</label>
        <div>
          <button id="viewWeek" class="btn" onclick="setView('week')">Week</button>
          <button id="viewMax" class="btn" onclick="setView('max')">Max</button>
        </div>
      </div>
      <div style="grid-column:span 3">
        <label>Allocation window — Start (inclusive)</label>
        <input id="winStart" type="date" value="2025-08-30"/>
      </div>
      <div style="grid-column:span 3">
        <label>Allocation window — End (inclusive)</label>
        <input id="winEnd" type="date"/>
      </div>
      <div style="grid-column:span 3">
        <label>Total Wallet Size at End of Window ($)</label>
        <input id="walletSize" type="number" step="0.01" value="0"/>
      </div>

      <div style="grid-column:span 3">
        <label>Realized profit this period (if wallet size = 0) ($)</label>
        <input id="realizedProfit" type="number" step="0.01" value="1500"/>
      </div>
      <div style="grid-column:span 3">
        <label>Moonbag <b>realized</b> this period ($)</label>
        <input id="moonbagReal" type="number" step="0.01" value="0"/>
      </div>
      <div style="grid-column:span 3">
        <label>Moonbag <b>unrealized</b> (valuation change) ($)</label>
        <input id="moonbagUnreal" type="number" step="0.01" value="0"/>
      </div>
      <div style="grid-column:span 3">
        <label>Include <b>unrealized</b> in Wallet identity?</label>
        <select id="includeUnreal">
          <option value="no" selected>No — track only</option>
          <option value="yes">Yes — include in identity</option>
        </select>
      </div>

      <div style="grid-column:span 3">
        <label>Moonbag founders share (%)</label>
        <input id="moonbagFounderPct" type="number" step="0.1" value="75"/>
      </div>
      <div style="grid-column:span 3">
        <label>Regular fund fee on investor base profit (%) → Founders</label>
        <input id="mgmtFeePct" type="number" step="0.1" value="20"/>
      </div>
      <div style="grid-column:span 3">
        <label>Entry fee on new investor capital (%) → Founders</label>
        <input id="entryFeePct" type="number" step="0.1" value="10"/>
      </div>
      <div style="grid-column:span 3">
        <label>Entry fee reduces investor credited capital?</label>
        <select id="feeReducesInvestor">
          <option value="yes" selected>Yes (net = gross × (1−fee))</option>
          <option value="no">No (investor credited full; fee outside)</option>
        </select>
      </div>

      <div style="grid-column:span 2">
        <label>Founders — count</label>
        <input id="founderCount" type="number" min="1" step="1" value="2"/>
      </div>
      <div style="grid-column:span 2">
        <label>Weekly draw per founder ($)</label>
        <input id="drawPerFounder" type="number" step="1" value="0"/>
      </div>
      <div style="grid-column:span 3">
        <label>Apply founders’ draws in this period?</label>
        <select id="applyDraws"><option value="no" selected>No</option><option value="yes">Yes</option></select>
      </div>
      <div style="grid-column:span 3">
        <label>Dominance lead margin (%) over largest investor</label>
        <input id="domLeadPct" type="number" step="0.1" value="0"/>
      </div>
      <div style="grid-column:span 1">
        <label>&nbsp;</label>
        <button class="btn" id="btnRecalc" onclick="recalc()">Recalculate</button>
      </div>
      <div style="grid-column:span 2">
        <label>&nbsp;</label>
        <button class="btn" id="btnSetComputed" onclick="setPoolToComputed()">Set Wallet = Computed</button>
      </div>
      <div style="grid-column:span 2">
        <label>&nbsp;</label>
        <button class="btn" id="btnAccumulate" onclick="accumulateToMax()">Accumulate this period → Max</button>
      </div>
      <div style="grid-column:span 1">
        <label>&nbsp;</label>
        <button class="btn" id="btnResetMax" onclick="resetMax()">Reset Max</button>
      </div>
    </div>

    <div class="small" style="margin-top:6px">
      Identity: <code>WalletEnd = Start + Contrib + BaseProfit + MoonbagRealized (+ Unrealized?) − Draws (if applied)</code>.
    </div>
    <div class="warnbox" id="consistencyBox" style="display:none">
      <b>Consistency check:</b> WalletEnd must be ≥ <span id="minWallet"></span> (= Start + Contrib − Draws?<span id="unrealTerm"></span> + MoonbagRealized).
      <button class="btn" style="margin-left:8px" onclick="setWalletToMin()">Set Wallet = minimum</button>
    </div>

    <div class="panel" style="margin-top:16px">
      <h2>Founders Contributions</h2>
      <div class="tablewrap">
        <table id="founderTable">
          <thead><tr><th style="width:35%">Date</th><th style="width:35%">Amount ($)</th><th>Action</th></tr></thead>
          <tbody id="founderBody">
            <tr>
              <td><input type="date" value="2025-07-10"/></td>
              <td><input type="number" step="0.01" value="5000"/></td>
              <td><span class="x" onclick="removeRow(this)">Remove</span></td>
            </tr>
          </tbody>
          <tfoot><tr><td colspan="3"><button class="btn" onclick="addFounderRow()">+ Add founder contribution</button></td></tr></tfoot>
        </table>
      </div>
      <div class="small">Investors’ entry & regular fund fees route to Founders. In <b>Max</b>, accumulated prior fees are added to founders’ capital (local only).</div>
    </div>

    <div class="panel">
      <h2>Investors & Contributions</h2>
      <div class="tablewrap">
        <table id="invTable">
          <thead>
            <tr>
              <th style="width:14%">Investor</th>
              <th style="width:18%">Date</th>
              <th style="width:18%">Amount ($)</th>
              <th style="width:18%">Gross→Net rule</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="invBody"></tbody>
          <tfoot>
            <tr><td colspan="5">
              <button class="btn" onclick="addInvestor()">+ Add investor</button>
              <button class="btn" onclick="addContribToSelected()">+ Add contribution to selected</button>
              <button class="btn" onclick="resetSelection()">Reset selection</button>
              <button class="btn" id="btnDefaults" onclick="resetToDefaults()">Reset to defaults</button>
            </td></tr>
          </tfoot>
        </table>
      </div>
      <div class="small" id="presetNote">Preset: Laura (7/22 $5k, 7/31 $5k, 8/25 $2.5k, 9/06 $2.5k); Damon (8/02 $5k). Fees: 10% entry, 20% regular fund fee on investor base profit only → Founders.</div>
    </div>

    <div class="panel">
      <h2>Audit — Row Classification</h2>
      <div id="auditBody" class="small"></div>
    </div>

    <div class="panel">
      <h2>Results (time‑weighted)</h2>
      <div id="kpis" class="small"></div>
      <div class="tablewrap">
        <table id="allocTable" style="margin-top:10px">
          <thead>
            <tr>
              <th>Class / Name</th>
              <th class="right">Start‑of‑window capital</th>
              <th class="right">Contribs in window</th>
              <th class="right">Dollar‑days (weight)</th>
              <th class="right">TW Share %</th>
              <th class="right">Base profit share</th>
              <th class="right">Regular fund fee (20%)</th>
              <th class="right">Moonbag (realized)</th>
              <th class="right">Draws</th>
              <th class="right">Net Profit (after fees)</th>
              <th class="right">PGP (period %)</th>
              <th class="right">End capital</th>
            </tr>
          </thead>
          <tbody id="allocBody"></tbody>
          <tfoot>
            <tr>
              <td><b>Totals</b></td>
              <td class="right" id="tStart">$0</td>
              <td class="right" id="tContrib">$0</td>
              <td class="right" id="tDD">$0</td>
              <td class="right" id="tTW">100%</td>
              <td class="right" id="tBase">$0</td>
              <td class="right" id="tFee">$0</td>
              <td class="right" id="tMoon">$0</td>
              <td class="right" id="tDraw">$0</td>
              <td class="right" id="tNet">$0</td>
              <td class="right" id="tPGP">—</td>
              <td class="right" id="tEnd">$0</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="small" id="domNote"></div>
    </div>

    <div class="panel">
      <h2>Fee Breakdown — Investors (base profit only)</h2>
      <div class="tablewrap">
        <table id="feeTable">
          <thead>
            <tr>
              <th>Investor</th>
              <th class="right">Base profit share</th>
              <th class="right">Fee rate</th>
              <th class="right">Fee amount</th>
            </tr>
          </thead>
          <tbody id="feeBody"></tbody>
          <tfoot>
            <tr>
              <td><b>Totals</b></td>
              <td class="right" id="feeBaseTotal">$0</td>
              <td class="right">—</td>
              <td class="right" id="feeAmtTotal">$0</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="small" id="feeNotes">Fee applies to investor <b>base</b> profit only; no fee on moonbag realized/unrealized.</div>
    </div>

    <div class="panel">
      <h2>Entry Fee Breakdown — Routed to Founders (10%)</h2>
      <div class="tablewrap">
        <table id="entryTable">
          <thead>
            <tr>
              <th>Investor</th>
              <th class="right">Entry fees — Pre‑start</th>
              <th class="right">Entry fees — In window</th>
              <th class="right">Total entry fees</th>
            </tr>
          </thead>
          <tbody id="entryBody"></tbody>
          <tfoot>
            <tr>
              <td><b>Totals</b></td>
              <td class="right" id="entryPreTotal">$0</td>
              <td class="right" id="entryInTotal">$0</td>
              <td class="right" id="entryAllTotal">$0</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="small">Entry fees are capital transfers to Founders. Pre‑start fees increase founders’ start‑of‑window capital; in‑window fees count as founders’ in‑window contribution and affect dollar‑days immediately.</div>
    </div>

    <div class="panel">
      <h2>Fees by Class — Founders & Investors</h2>
      <div class="tablewrap">
        <table id="feeClassTable">
          <thead>
            <tr>
              <th>Class / Name</th>
              <th class="right">Base profit share</th>
              <th class="right">Mgmt fee role</th>
              <th class="right">Mgmt fee rate</th>
              <th class="right">Mgmt fee amount (±)</th>
              <th class="right">Entry fees this window (±)</th>
            </tr>
          </thead>
          <tbody id="feeClassBody"></tbody>
          <tfoot>
            <tr>
              <td><b>Totals</b></td>
              <td class="right" id="feeClassBaseTotal">$0</td>
              <td class="right">—</td>
              <td class="right">—</td>
              <td class="right" id="feeClassAmtTotal">$0</td>
              <td class="right" id="feeClassEntryWinTotal">$0</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="small">Founders receive investor fees; investors pay 20% of positive base shares; no fee on moonbag.</div>
    </div>

    <div class="panel">
      <h2>Diagnostics — Presence</h2>
      <div id="diagList" class="small"></div>
    </div>
  </div>

  <!-- ===== HISTORY ===== -->
  <div class="panel" data-pane="history" style="display:none">
    <h2>Saved Snapshots</h2>
    <div class="small">Snapshots are saved to your browser’s local storage. They include inputs and computed results (for charts).</div>
    <div id="histList" class="small" style="margin-top:10px"></div>
    <div class="hr"></div>
    <div>
      <button class="btn" onclick="exportHistory()">Export history</button>
      <input type="file" id="histFile" accept=".json" style="display:none"/>
      <button class="btn" onclick="document.getElementById('histFile').click()">Import history</button>
      <button class="btn" onclick="clearHistory()">Clear history</button>
    </div>
  </div>

  <!-- ===== CHARTS ===== -->
  <div class="panel" data-pane="charts" style="display:none">
    <h2>Charts</h2>
    <div class="grid" style="align-items:center">
      <div style="grid-column:span 4">
        <label>Data Source</label>
        <select id="chartSource">
          <option value="current">Current (on screen)</option>
          <option value="latest">Latest saved snapshot</option>
          <option value="all">All saved snapshots (time series)</option>
        </select>
      </div>
      <div style="grid-column:span 5">
        <label>Chart Type</label>
        <select id="chartType">
          <option value="lineNet">Line — Net profit (per class)</option>
          <option value="barNet">Bar — Net profit (per class)</option>
          <option value="barBase">Bar — Base profit (per class)</option>
          <option value="lineEnd">Line — End capital (per class)</option>
          <option value="linePGP">Line — PGP (period %, time‑weighted)</option>
        </select>
      </div>
      <div style="grid-column:span 2">
        <label>Include Founders in line charts?</label>
        <select id="chartInclF"><option value="yes" selected>Yes</option><option value="no">No</option></select>
      </div>
      <div style="grid-column:span 1">
        <label>&nbsp;</label>
        <button class="btn" onclick="drawChart()">Draw</button>
      </div>
    </div>
    <div style="margin-top:12px">
      <canvas id="chart" width="1100" height="420"></canvas>
      <div class="legend" id="legend"></div>
      <div class="small" id="chartNote"></div>
      <div class="small" style="margin-top:6px"><b id="yAxisTitle"></b> — Y‑axis · <b id="xAxisTitle"></b> — X‑axis</div>
    </div>
  </div>

  <!-- ===== AUDIT ===== -->
  <div class="panel" data-pane="audit" style="display:none">
    <h2>Founders Audit — Composition & Math</h2>
    <div id="auditFounders" class="small"></div>
  </div>

  <!-- ===== ASSISTANT ===== -->
  <div class="panel" data-pane="assistant" style="display:none">
    <h2>AI Assistant</h2>
    <h3 style="margin: 8px 0 6px;">Screenshot OCR</h3>
    <div>
      <label class="small">Upload an image (screenshot) with text data:</label><br/>
      <input type="file" id="fileInput" accept="image/*"/>
      <button class="btn" id="btnOCR" style="margin-top:6px;">Extract Text</button>
      <div id="ocrOutputWrapper" style="margin-top:12px;">
        <label>Recognized Text:</label>
        <textarea id="ocrOutput" rows="6" style="margin-top:4px;"></textarea>
      </div>
      <div class="small" style="margin-top:4px;">* After extracting, you can modify the text if needed and import data into the calculator.</div>
    </div>
    <div class="hr"></div>
    <h3 style="margin: 8px 0 6px;">Import Data</h3>
    <div class="grid">
      <div style="grid-column:span 4">
        <label>Import as</label>
        <select id="ocrImportType">
          <option value="investor">Investor contributions</option>
          <option value="founder">Founder contributions</option>
        </select>
      </div>
      <div style="grid-column:span 5">
        <label>Investor Name (if adding investor data)</label>
        <input type="text" id="ocrInvestorName" placeholder="Investor"/>
      </div>
      <div style="grid-column:span 3">
        <label>&nbsp;</label>
        <button class="btn" id="btnImportOCR">Import to Calculator</button>
      </div>
    </div>
    <div class="small" style="margin-top:6px;">* For investor data, provide the name. Recognized dates & amounts will be added as contributions.</div>
    <div class="hr"></div>
    <h3 style="margin: 8px 0 6px;">Export Results</h3>
    <div>
      <button class="btn" id="btnExportPDF">Export PDF</button>
      <div class="small" style="margin-top:4px;">Download the current results tables as a PDF report.</div>
    </div>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const $ = (id) => document.getElementById(id);
function money(x){return '$'+Number(x||0).toLocaleString(undefined,{maximumFractionDigits:2})}
function pct(x){return (100*(x||0)).toFixed(2)+'%'}
function daysBetweenInclusive(d0,d1){const ms=(new Date(d1)-new Date(d0));return Math.floor(ms/86400000)+1}
function parseNum(v){const x=parseFloat(v);return isNaN(x)?0:x}
function todayISO(){const d=new Date();return d.toISOString().slice(0,10)}

/* ---------- tabs ---------- */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(a=>a.classList.remove('active'));
    t.classList.add('active');
    const tab=t.dataset.tab;
    document.querySelectorAll('[data-pane]').forEach(p=>p.style.display=(p.dataset.pane===tab)?'block':'none');
    if(tab==='history') renderHistory();
  });
});

/* ---------- view (week/max) ---------- */
let viewMode='week';
function setView(mode){viewMode=mode;$('viewWeek').classList.toggle('active',mode==='week');$('viewMax').classList.toggle('active',mode==='max');recalc();}

/* ---------- investor table ops ---------- */
let selectedRow=null;
function resetSelection(){const tbody=$('invBody');[...tbody.children].forEach(r=>r.style.outline='none');selectedRow=null}
function removeRow(el){el.closest('tr').remove()}
function addInvestor(name='Investor'){
  const tbody=$('invBody'); const tr=document.createElement('tr');
  tr.onclick=()=>{selectedRow=tr;[...tbody.children].forEach(r=>r.style.outline='none');tr.style.outline='1px dashed #3b82f6'};
  tr.innerHTML=`<td><input type="text" value="${name}"/></td>
<td><input type="date" value="${todayISO()}"/></td>
<td><input type="number" step="0.01" value="0"/></td>
<td><select><option value="default" selected>Use global</option><option value="yes">Reduce investor by fee</option><option value="no">Fee outside (investor full)</option></select></td>
<td><span class="x" onclick="addContribInline(this)">+ Add</span> · <span class="x" onclick="removeRow(this)">Remove</span></td>`;
  tbody.appendChild(tr);
}
function addContribInline(el){
  const tr=el.closest('tr'); const clone=tr.cloneNode(true); clone.style.outline='none';
  const tbody=$('invBody');
  clone.onclick=()=>{selectedRow=clone;[...tbody.children].forEach(r=>r.style.outline='none');clone.style.outline='1px dashed #3b82f6'};
  clone.querySelector('td:nth-child(2) input').value=todayISO();
  clone.querySelector('td:nth-child(3) input').value='0';
  tbody.appendChild(clone);
}
function addContribToSelected(){ if(!selectedRow){alert('Click a row to select an investor first.');return;} addContribInline(selectedRow.querySelector('.x')); }
function resetToDefaults(){ $('invBody').innerHTML=''; seedInvestors(); recalc(); }
function addFounderRow(dateStr='',amt=''){const tr=document.createElement('tr');tr.innerHTML=`<td><input type="date" value="${dateStr||'2025-07-10'}"/></td><td><input type="number" step="0.01" value="${amt||'0'}"/></td><td><span class="x" onclick="removeRow(this)">Remove</span></td>`;$('founderBody').appendChild(tr)}

/* ---------- seeds ---------- */
function seedInvestors(){
  const tbody=$('invBody'); tbody.innerHTML='';
  function row(name,dateStr,amt){const tr=document.createElement('tr');tr.onclick=()=>{selectedRow=tr;[...tbody.children].forEach(r=>r.style.outline='none');tr.style.outline='1px dashed #3b82f6'};tr.innerHTML=`<td><input type="text" value="${name}"/></td><td><input type="date" value="${dateStr}"/></td><td><input type="number" step="0.01" value="${amt}"/></td><td><select><option value="default" selected>Use global</option><option value="yes">Reduce investor by fee</option><option value="no">Fee outside (investor full)</option></select></td><td><span class="x" onclick="addContribInline(this)">+ Add</span> · <span class="x" onclick="removeRow(this)">Remove</span></td>`;tbody.appendChild(tr)}
  row('Laura','2025-07-22','5000');
  row('Laura','2025-07-31','5000');
  row('Laura','2025-08-25','2500');
  row('Laura','2025-09-06','2500');
  row('Damon','2025-08-02','5000');
}

/* ---------- founders gather ---------- */
function gatherFounders(start,end){
  const rows=[...document.querySelectorAll('#founderBody tr')];
  let startCap=0,contribInWin=0,dd=0;
  for(const r of rows){
    const d=r.querySelector('td:nth-child(1) input').value;
    const a=parseNum(r.querySelector('td:nth-child(2) input').value);
    if(a<=0||!d)continue;
    if(d<=start)startCap+=a;
    const inWinStart=d<start?start:d;
    if(inWinStart<=end){
      const days=daysBetweenInclusive(inWinStart,end);
      dd+=a*days;
      if(d>start&&d<=end)contribInWin+=a;
    }
  }
  return {startCap,contribInWin,dd};
}

/* ---------- classify (audit text) ---------- */
function classifyRows(start,end){
  const feeReduceGlobal=$('feeReducesInvestor').value;
  const entryFee=parseNum($('entryFeePct').value)/100.0;
  const invRows=[...$('invBody').children];
  let lines=[];
  for(const r of invRows){
    const name=r.querySelector('td:nth-child(1) input').value.trim()||'Investor';
    const d=r.querySelector('td:nth-child(2) input').value;
    let aGross=parseNum(r.querySelector('td:nth-child(3) input').value);
    if(aGross<=0||!d)continue;
    const feeSel=r.querySelector('td:nth-child(4) select').value;
    const feeMode=(feeSel==='default')?feeReduceGlobal:feeSel;
    const aNet=(feeMode==='yes')?aGross*(1-entryFee):aGross;
    let status='';
    if(d<=start)status='Pre‑start → Start‑of‑window';
    else if(d>start&&d<=end)status='In‑window → Contribs in window';
    else status='Post‑end → ignored';
    lines.push(`${name} — $${aGross.toFixed(2)} on ${d} → ${status} — net counted: $${aNet.toFixed(2)}`);
  }
  return lines.join('<br/>');
}

/* ---------- max ledger ---------- */
const LS_MAX='ff_max_accum_v2m';
function loadMax(){try{return parseNum(localStorage.getItem(LS_MAX)||'0')}catch(e){return 0}}
function saveMax(v){try{localStorage.setItem(LS_MAX,String(v))}catch(e){}}
function resetMax(){saveMax(0);recalc()}
function accumulateToMax(){const out=compute(true);const add=out.feesToFounders_total;saveMax(loadMax()+add);recalc()}

/* ---------- compute ---------- */
function compute(dry=false){
  const start=$('winStart').value;
  const end=$('winEnd').value || todayISO();
  const totalDays=daysBetweenInclusive(start,end);

  const mgmtFee=parseNum($('mgmtFeePct').value)/100.0;
  const entryFee=parseNum($('entryFeePct').value)/100.0;
  const feeReduceGlobal=$('feeReducesInvestor').value;
  const moonbagFounderPct=parseNum($('moonbagFounderPct').value)/100.0;
  const moonbagReal=parseNum($('moonbagReal').value);
  const moonbagUnreal=parseNum($('moonbagUnreal').value);
  const includeUnreal=($('includeUnreal').value==='yes');
  const founderCount=Math.max(1,parseInt(parseNum($('founderCount').value)));
  const drawPer=parseNum($('drawPerFounder').value);
  const applyDraws=($('applyDraws').value==='yes');
  const drawTotal=applyDraws ? founderCount*drawPer : 0;
  const domLead=parseNum($('domLeadPct').value)/100.0;

  // Founders baseline
  let f=gatherFounders(start,end);
  const maxLedger=(viewMode==='max')?loadMax():0;
  if(maxLedger>0){ f.startCap+=maxLedger; f.dd+=maxLedger*totalDays; }

  // Investors
  const invRows=[...$('invBody').children];
  let invMap=new Map(); let invDDsum=0; let entryFees_thisWin=0;
  let entryPreBy=new Map(), entryInBy=new Map();

  for(const r of invRows){
    const name=(r.querySelector('td:nth-child(1) input').value.trim()||'Investor');
    const d=r.querySelector('td:nth-child(2) input').value;
    let aGross=parseNum(r.querySelector('td:nth-child(3) input').value);
    if(aGross<=0||!d)continue;
    const feeSel=r.querySelector('td:nth-child(4) select').value;
    const feeMode=(feeSel==='default')?feeReduceGlobal:feeSel;
    const aNet=(feeMode==='yes')?aGross*(1-entryFee):aGross;
    const entryAmt=aGross*entryFee;

    if(!invMap.has(name))invMap.set(name,{name,startCap:0,contribInWin:0,dd:0,preStart:0});
    const rec=invMap.get(name);

    if(d<=start){ rec.startCap+=aNet; rec.preStart+=aNet; }
    const inWinStart=d<start?start:d;
    if(inWinStart<=end){
      const days=daysBetweenInclusive(inWinStart,end);
      rec.dd+=aNet*days; invDDsum+=aNet*days;
      if(d>start&&d<=end)rec.contribInWin+=aNet;

      // Founders get entry fees as capital
      f.dd+=entryAmt*days;
      if(d<=start){ f.startCap+=entryAmt; entryPreBy.set(name,(entryPreBy.get(name)||0)+entryAmt); }
      if(d>start&&d<=end){ f.contribInWin=(f.contribInWin||0)+entryAmt; entryInBy.set(name,(entryInBy.get(name)||0)+entryAmt); entryFees_thisWin+=entryAmt; }
    }
    invMap.set(name,rec);
  }

  const totalDD=f.dd+invDDsum;
  const shareF=(totalDD>0)?(f.dd/totalDD):0;

  // Totals for identity
  const invList_tmp=[]; invMap.forEach(v=>invList_tmp.push(v));
  const invStartSum=invList_tmp.reduce((s,x)=>s+x.startCap,0);
  const invContribSum=invList_tmp.reduce((s,x)=>s+x.contribInWin,0);
  const totalStartCap=f.startCap+invStartSum;
  const totalContribWin=(f.contribInWin||0)+invContribSum;

  // Wallet identity
  const walletSize=parseNum($('walletSize').value);
  const minWallet=totalStartCap+totalContribWin-(drawTotal)+(moonbagReal)+(includeUnreal?moonbagUnreal:0);
  let profitCore=0;
  if(walletSize>0){
    profitCore=walletSize-totalStartCap-totalContribWin+drawTotal-moonbagReal-(includeUnreal?moonbagUnreal:0);
  }else{
    profitCore=parseNum($('realizedProfit').value);
  }

  // Base profit allocations by time-weight
  const baseF=profitCore*shareF;
  const invList=[]; invMap.forEach(v=>invList.push(v));
  const baseI_each=invList.map(x=>profitCore*(totalDD>0?x.dd/totalDD:0));

  // Regular management fee (on investor base profit > 0)
  const feeFromI_each=baseI_each.map(x=>x>0?x*mgmtFee:0);
  const feeFromI_total=feeFromI_each.reduce((s,x)=>s+x,0);

  // Moonbag realized split
  const moonF=moonbagReal*moonbagFounderPct;
  const moonI_total=moonbagReal-moonF;
  const moonI_each=invList.map(x=>invDDsum>0?moonI_total*(x.dd/invDDsum):0);

  // Net profits
  const netF=baseF+feeFromI_total+moonF-(drawTotal);
  const netI_each=invList.map((x,i)=>(baseI_each[i]-feeFromI_each[i])+moonI_each[i]);

  // End capitals
  const endF=f.startCap+(f.contribInWin||0)+netF;
  const endI_each=invList.map((x,i)=>x.startCap+x.contribInWin+netI_each[i]);
  const endSum=endF+endI_each.reduce((s,x)=>s+x,0);

  // Dominance
  const maxInvEnd=endI_each.length?Math.max(...endI_each):0;
  const reqF=maxInvEnd*(1+domLead);
  let domState='warn',domMsg='';
  if(endF>=reqF){domState='good';domMsg='Dominance OK';}
  else if(((f.startCap+(f.contribInWin||0)+baseF+feeFromI_total+moonF))>=reqF){domState='warn';domMsg='Reduce draw to maintain dominance.';}
  else{domState='bad';domMsg='Increase profit or reduce draws; founders below largest investor.';}

  // PGP (period) values
  const pgpF=(f.dd>0)?(netF*totalDays/f.dd):0;

  // Investor summary for tables
  const invSummary=invList.map((x,i)=>({
    name:x.name, startCap:x.startCap, contribInWin:x.contribInWin, dd:x.dd,
    base:baseI_each[i], feeMgmt:feeFromI_each[i], moon:moonI_each[i],
    net:netI_each[i], end:endI_each[i],
    entryPre:(0), entryIn:(0),
    pgp:(x.dd>0)?(netI_each[i]*totalDays/x.dd):0
  }));
  invSummary.forEach(r=>{
    r.entryPre = ( (entryPreBy.get(r.name) || entryPreBy.get(r.name.toLowerCase()) ) || 0);
    r.entryIn  = ( (entryInBy.get(r.name)  || entryInBy.get(r.name.toLowerCase())  ) || 0);
  });

  const feesToFounders_total=entryFees_thisWin+feeFromI_total;

  return {start,end,totalDays,f,invList,invSummary,invDDsum,totalDD,shareF,
          totalStartCap,totalContribWin,profitCore,moonbagReal,moonbagUnreal,includeUnreal,
          moonF,baseF,baseI_each,feeFromI_each,feeFromI_total,moonI_total,moonI_each,
          netF,netI_each,endF,endI_each,endSum,domState,domMsg,reqF,maxInvEnd,drawTotal,
          feesToFounders_total,pgpF,walletSize,minWallet,mgmtFee,applyDraws};
}

/* ---------- recalc & render ---------- */
function recalc(){
  const start=$('winStart').value; const end=$('winEnd').value||todayISO();
  if(!start||!end){alert('Set allocation window dates.');return;}
  const out=compute(false);

  // Consistency warning
  $('minWallet').textContent=money(out.minWallet);
  $('unrealTerm').textContent=(out.includeUnreal?' + Unrealized':'');
  const box=$('consistencyBox'); box.style.display=(out.walletSize>0 && out.walletSize<out.minWallet)?'block':'none';

  // KPIs
  const k=$('kpis'); k.innerHTML='';
  const pill=(label,val)=>`<span class="pill"><b>${label}:</b> ${money(val)}</span>`;
  const investorsNet=out.netI_each.reduce((s,x)=>s+x,0);
  k.innerHTML=pill('Investors net profit (after fee)',investorsNet)
             +pill('Regular fund fee → Founders',out.feeFromI_total)
             +pill('Founders net profit (after fees & draws)',out.netF)
             +pill('Moonbag realized (total)',out.moonbagReal)
             +pill('Computed end pool',out.endSum);

  // Audit — classification
  $('auditBody').innerHTML=classifyRows(start,end);

  // Results table
  const tb=$('allocBody'); tb.innerHTML='';
  const pgpFmt=v=> (isFinite(v)?(v*100).toFixed(2)+'%':'—');
  function row(nameHtml,sc,cw,dd,twp,bp,fee,moon,draw,net,pgpStr,endv){
    return `<tr><td>${nameHtml}</td>
      <td class="right">${money(sc)}</td><td class="right">${money(cw)}</td>
      <td class="right">${money(dd)}</td><td class="right">${twp}</td>
      <td class="right">${money(bp)}</td><td class="right">${money(fee)}</td>
      <td class="right">${money(moon)}</td><td class="right">${money(draw)}</td>
      <td class="right">${money(net)}</td><td class="right">${pgpStr}</td>
      <td class="right">${money(endv)}</td></tr>`;
  }
  const twF=(out.totalDD>0)?pct(out.f.dd/out.totalDD):'0.00%';
  const foundersHTML=`<div class="namecell"><span>Founders</span><span class="badge">Pre‑start: ${money(out.f.startCap)}</span></div>`;
  tb.insertAdjacentHTML('beforeend',row(foundersHTML,out.f.startCap,(out.f.contribInWin||0),out.f.dd,twF,out.baseF,out.feeFromI_total,out.moonF,out.drawTotal,out.netF,pgpFmt(out.pgpF),out.endF));

  const namesPresent=new Set(out.invSummary.map(r=>r.name.toLowerCase()));
  function inject(r){
    const twp=(out.totalDD>0)?pct(r.dd/out.totalDD):'0.00%';
    tb.insertAdjacentHTML('beforeend',row(
      `<div class="namecell"><span>${r.name}</span><span class="badge">Pre‑start: ${money(r.startCap)}</span></div>`,
      r.startCap,r.contribInWin,r.dd,twp,r.base,-r.feeMgmt,r.moon,0,r.net,pgpFmt(r.pgp),r.end));
  }
  out.invSummary.forEach(inject);
  if(!namesPresent.has('laura')) inject({name:'Laura',startCap:0,contribInWin:0,dd:0,base:0,feeMgmt:0,moon:0,net:0,pgp:0,end:0});
  if(!namesPresent.has('damon')) inject({name:'Damon',startCap:0,contribInWin:0,dd:0,base:0,feeMgmt:0,moon:0,net:0,pgp:0,end:0});

  // Totals
  $('tStart').textContent=money(out.totalStartCap);
  $('tContrib').textContent=money(out.totalContribWin);
  $('tDD').textContent=money(out.totalDD);
  $('tTW').textContent='100%';
  $('tBase').textContent=money(out.baseF+out.baseI_each.reduce((s,x)=>s+x,0));
  $('tFee').textContent=money(out.feeFromI_total);
  $('tMoon').textContent=money(out.moonbagReal);
  $('tDraw').textContent=money(out.drawTotal);
  $('tNet').textContent=money(out.netF+out.netI_each.reduce((s,x)=>s+x,0));
  $('tEnd').textContent=money(out.endSum);
  $('tPGP').textContent='—';

  // Dominance note
  $('domNote').innerHTML=`<b>Dominance:</b> Founders end = ${money(out.endF)}; Max investor end = ${money(Math.max(0,...out.invSummary.map(r=>r.end)))}; Required founders ≥ ${money(out.reqF)} — ${out.domMsg}`;

  // Fee Breakdown — investors
  const fb=$('feeBody'); fb.innerHTML=''; let baseTotal=0, feeTotal=0;
  out.invSummary.forEach(r=>{
    baseTotal+=r.base; feeTotal+=r.base>0?r.feeMgmt:0;
    fb.insertAdjacentHTML('beforeend',`<tr><td>${r.name}</td><td class="right">${money(r.base)}</td><td class="right">${(out.mgmtFee*100).toFixed(2)}%</td><td class="right">${money(r.base>0?r.feeMgmt:0)}</td></tr>`);
  });
  if(!namesPresent.has('laura')) fb.insertAdjacentHTML('beforeend', `<tr><td>Laura</td><td class="right">$0</td><td class="right">—</td><td class="right">$0</td></tr>`);
  if(!namesPresent.has('damon')) fb.insertAdjacentHTML('beforeend', `<tr><td>Damon</td><td class="right">$0</td><td class="right">—</td><td class="right">$0</td></tr>`);
  $('feeBaseTotal').textContent=money(baseTotal); $('feeAmtTotal').textContent=money(feeTotal);
  $('feeNotes').innerHTML='Fee applies to investor <b>base</b> profit only; no fee on moonbag realized/unrealized.';

  // Entry Fee Breakdown
  const eb=$('entryBody'); eb.innerHTML=''; let preTot=0,inTot=0;
  const nameSet=new Set([...out.invSummary.map(r=>r.name)]);
  nameSet.add('Laura'); nameSet.add('Damon');
  nameSet.forEach(n=>{
    const pre = out.invSummary.find(r=>r.name===n)?.entryPre || 0;
    const inn = out.invSummary.find(r=>r.name===n)?.entryIn  || 0;
    preTot+=pre; inTot+=inn;
    eb.insertAdjacentHTML('beforeend', `<tr><td>${n}</td><td class="right">${money(pre)}</td><td class="right">${money(inn)}</td><td class="right">${money(pre+inn)}</td></tr>`);
  });
  $('entryPreTotal').textContent=money(preTot); $('entryInTotal').textContent=money(inTot); $('entryAllTotal').textContent=money(preTot+inTot);

  // Fees by Class
  const fcb=$('feeClassBody'); fcb.innerHTML='';
  let clsBaseTotal=out.baseF, clsFeeTotal=out.feeFromI_total, entryWinTotal=inTot;
  fcb.insertAdjacentHTML('beforeend', `<tr>
    <td>Founders</td><td class="right">${money(out.baseF)}</td><td class="right">Receives</td><td class="right">—</td>
    <td class="right">${money(out.feeFromI_total)}</td><td class="right">${money(inTot)}</td></tr>`);
  out.invSummary.forEach(r=>{
    fcb.insertAdjacentHTML('beforeend', `<tr>
      <td>${r.name}</td><td class="right">${money(r.base)}</td>
      <td class="right">${r.base>0?'Pays':'No fee (≤0 base)'}</td>
      <td class="right">${r.base>0?parseNum($('mgmtFeePct').value).toFixed(2)+'%':'—'}</td>
      <td class="right">${money(- (r.base>0?r.feeMgmt:0))}</td>
      <td class="right">$0</td></tr>`);
    clsBaseTotal+=r.base; clsFeeTotal-= (r.base>0?r.feeMgmt:0);
  });
  $('feeClassBaseTotal').textContent=money(clsBaseTotal);
  $('feeClassAmtTotal').textContent=money(clsFeeTotal);
  $('feeClassEntryWinTotal').textContent=money(entryWinTotal);

  // Founders Audit
  renderFoundersAudit(out);

  // Diagnostics
  renderDiagnostics();

  if($('autoSave').checked){ saveSnapshot(out); }
  $('calcTime').textContent='Last calc: '+(new Date()).toLocaleTimeString();
}

/* ---------- founders audit ---------- */
function renderFoundersAudit(out){
  const A=$('auditFounders'); const shareF=(out.totalDD>0)?out.f.dd/out.totalDD:0;
  const pgpFmt=v=>(isFinite(v)?(v*100).toFixed(2)+'%':'—');
  A.innerHTML=`
    <div class="grid" style="grid-template-columns: 1fr 1fr; gap:6px">
      <div>Window</div><div class="right">${out.start} → ${out.end} (${out.totalDays} days)</div>
      <div>Founders start‑of‑window capital</div><div class="right">${money(out.f.startCap)}</div>
      <div>Founders contribs in window (incl. entry fees)</div><div class="right">${money(out.f.contribInWin||0)}</div>
      <div>Founders dollar‑days</div><div class="right">${money(out.f.dd)}</div>
      <div>Founders TW share</div><div class="right">${pct(shareF)}</div>
      <div>Base profit (by TW share)</div><div class="right">${money(out.baseF)}</div>
      <div>Mgmt fees received from investors</div><div class="right">${money(out.feeFromI_total)}</div>
      <div>Moonbag realized to founders</div><div class="right">${money(out.moonF)}</div>
      <div>Draws (applied?)</div><div class="right">${out.applyDraws?('-'+money(out.drawTotal)):'$0.00'}</div>
      <div><b>Net profit (founders)</b></div><div class="right"><b>${money(out.netF)}</b></div>
      <div><b>End capital (founders)</b></div><div class="right"><b>${money(out.endF)}</b></div>
      <div>PGP (period %, time‑weighted)</div><div class="right">${pgpFmt(out.pgpF)}</div>
      <div>Identity minimum WalletEnd check</div><div class="right">${money(out.minWallet)}</div>
    </div>`;
}

/* ---------- diagnostics ---------- */
function renderDiagnostics(){
  const checks=[
    ['winStart','Start date input'],['winEnd','End date input'],['walletSize','Wallet size input'],
    ['realizedProfit','Realized profit input'],['moonbagReal','Moonbag realized input'],
    ['moonbagUnreal','Moonbag unrealized input'],['includeUnreal','Include unrealized toggle'],
    ['moonbagFounderPct','Moonbag founders %'],['mgmtFeePct','Regular fund fee %'],
    ['entryFeePct','Entry fee %'],['feeReducesInvestor','Entry fee net rule toggle'],
    ['founderCount','Founders count'],['drawPerFounder','Weekly draw per founder'],
    ['applyDraws','Apply draws toggle'],['domLeadPct','Dominance lead %'],['founderBody','Founders table body'],['invBody','Investors table body'],
    ['auditBody','Audit panel'],['kpis','KPI bar'],['allocBody','Results body'],
    ['feeBody','Fee breakdown body'],['entryBody','Entry fee body'],['feeClassBody','Fee by Class body'],
    ['consistencyBox','Consistency box'],['btnRecalc','Recalculate button'],
    ['btnSetComputed','Set Wallet = Computed'],['btnAccumulate','Accumulate→Max'],['btnResetMax','Reset Max']
  ];
  const el=$('diagList'); el.innerHTML='';
  checks.forEach(([id,label])=>{
    const ok=!!$(id); el.insertAdjacentHTML('beforeend', `<div>${label} — <b style="color:${ok?'#8df59b':'#ff8a8a'}">${ok?'OK':'MISSING'}</b></div>`);
  });
}

/* ---------- wallet = computed ---------- */
function setPoolToComputed(){recalc();const txt=$('tEnd').textContent.replace(/[$,]/g,'');const v=parseFloat(txt)||0;$('walletSize').value=v.toFixed(2)}

/* ---------- history ---------- */
const LS_HIST='ff_hist_v2m';
function loadHistory(){try{return JSON.parse(localStorage.getItem(LS_HIST)||'[]')}catch(e){return []}}
function saveHistory(arr){try{localStorage.setItem(LS_HIST,JSON.stringify(arr))}catch(e){}}
function saveSnapshot(out){
  const snap={ts:new Date().toISOString(),
    inputs:{winStart:$('winStart').value,winEnd:$('winEnd').value||todayISO(),walletSize:parseNum($('walletSize').value),
      realizedProfit:parseNum($('realizedProfit').value),moonbagReal:parseNum($('moonbagReal').value),
      moonbagUnreal:parseNum($('moonbagUnreal').value),includeUnreal:$('includeUnreal').value,
      moonbagFounderPct:parseNum($('moonbagFounderPct').value),mgmtFeePct:parseNum($('mgmtFeePct').value),
      entryFeePct:parseNum($('entryFeePct').value),feeReducesInvestor:$('feeReducesInvestor').value,
      founderCount:parseNum($('founderCount').value),drawPerFounder:parseNum($('drawPerFounder').value),
      applyDraws:$('applyDraws').value,domLeadPct:parseNum($('domLeadPct').value)},
    results:{
      founders:{end:out.endF,net:out.netF,base:out.baseF,pgp:out.pgpF},
      investors: out.invSummary.map(r=>({name:r.name,end:r.end,net:r.net,base:r.base,pgp:r.pgp})),
      totals:{end:out.endSum}, start:out.start, end:out.end
    }};
  const arr=loadHistory(); arr.push(snap); saveHistory(arr);
}
function renderHistory(){
  const arr=loadHistory(); const list=$('histList'); list.innerHTML='';
  if(arr.length===0){ list.innerHTML='<i>No snapshots saved yet.</i>'; return; }
  arr.forEach((s,i)=>{
    list.insertAdjacentHTML('beforeend',`<div class="panel" style="padding:10px;margin:8px 0">
      <div><b>${new Date(s.ts).toLocaleString()}</b> · Window: ${s.results.start} → ${s.results.end} · End pool: ${money(s.results.totals.end)}
        <button class="btn" onclick="loadSnapshot(${i})">Load</button>
        <button class="btn" onclick="deleteSnapshot(${i})">Delete</button>
      </div></div>`);
  });
}
function loadSnapshot(i){
  const arr=loadHistory(); const s=arr[i]; if(!s)return;
  $('winStart').value=s.inputs.winStart; $('winEnd').value=s.inputs.winEnd;
  $('walletSize').value=s.inputs.walletSize; $('realizedProfit').value=s.inputs.realizedProfit;
  $('moonbagReal').value=s.inputs.moonbagReal; $('moonbagUnreal').value=s.inputs.moonbagUnreal;
  $('includeUnreal').value=s.inputs.includeUnreal;
  $('moonbagFounderPct').value=s.inputs.moonbagFounderPct;
  $('mgmtFeePct').value=s.inputs.mgmtFeePct; $('entryFeePct').value=s.inputs.entryFeePct;
  $('feeReducesInvestor').value=s.inputs.feeReducesInvestor;
  $('founderCount').value=s.inputs.founderCount; $('drawPerFounder').value=s.inputs.drawPerFounder;
  $('applyDraws').value=s.inputs.applyDraws || 'no';
  $('domLeadPct').value=s.inputs.domLeadPct;
  recalc();
}
function deleteSnapshot(i){const arr=loadHistory(); arr.splice(i,1); saveHistory(arr); renderHistory()}
function exportHistory(){const data=JSON.stringify(loadHistory(),null,2); const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(data); a.download='founders_fund_history.json'; a.click();}
$('histFile').addEventListener('change',(e)=>{const f=e.target.files[0]; if(!f)return; const rd=new FileReader(); rd.onload=()=>{try{const arr=JSON.parse(rd.result); saveHistory(arr); renderHistory();}catch(err){alert('Invalid JSON');}}; rd.readAsText(f);});
function clearHistory(){if(!confirm('Clear all snapshots?'))return; saveHistory([]); renderHistory()}

/* ---------- charts ---------- */
function seriesColors(names){const base=['#48b0f7','#f7a048','#9ad84b','#c17bff','#ff7b9c','#5ad1c9','#e2ff6f','#fcd34d','#60a5fa','#f472b6']; const map={}; names.forEach((n,i)=>map[n]=base[i%base.length]); return map;}
function drawAxes(ctx,W,H,P,minV,maxV,labels,fmt){
  ctx.clearRect(0,0,W,H); ctx.strokeStyle='#2b3b55'; ctx.lineWidth=1; const ticks=5; const step=(maxV-minV)/ticks; ctx.font='12px system-ui'; ctx.fillStyle='#9aa4b2';
  for(let i=0;i<=ticks;i++){const v=minV+i*step; const y=(H-P)-((v-minV)/(maxV-minV))*(H-2*P); ctx.beginPath(); ctx.moveTo(P,y); ctx.lineTo(W-P,y); ctx.stroke(); ctx.fillText(fmt(v),6,y-2);}
  const n=labels.length; if(n>0){const stepX=(W-2*P)/Math.max(1,n-1); for(let i=0;i<n;i++){const x=P+i*stepX; ctx.fillText(labels[i], x-18, H-8);}}
  ctx.strokeStyle='#3a4a6b'; ctx.strokeRect(P,P,W-2*P,H-2*P);
}
function drawPoint(ctx,x,y,color){ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();}
function drawChart(){
  const src=$('chartSource').value, type=$('chartType').value, includeF=($('chartInclF').value==='yes');
  const cv=$('chart'); const ctx=cv.getContext('2d'); const W=cv.width,H=cv.height,P=50;
  const legend=$('legend'); legend.innerHTML='';
  const srcSnaps=(()=>{
    if(src==='current'){const out=compute(false); return [{ts:new Date().toISOString(),inputs:{winStart:out.start,winEnd:out.end},results:{founders:{end:out.endF,net:out.netF,base:out.baseF,pgp:out.pgpF},investors:out.invSummary.map(r=>({name:r.name,end:r.end,net:r.net,base:r.base,pgp:r.pgp}))}}];}
    if(src==='latest'){const arr=loadHistory(); return arr.length?[arr[arr.length-1]]:[];}
    return loadHistory();
  })();
  if(srcSnaps.length===0){$('chartNote').textContent='No data to plot. Save snapshots or use Current source.'; ctx.clearRect(0,0,W,H); return;}

  const namesSet=new Set(); srcSnaps.forEach(s=>(s.results.investors||[]).forEach(r=>namesSet.add(r.name)));
  let names=Array.from(namesSet); if(includeF) names=['Founders',...names];
  const labels=(src==='all')?srcSnaps.map(s=>new Date(s.ts).toLocaleDateString()):srcSnaps.map((s,i)=>i===0?new Date(s.ts).toLocaleDateString():'');
  const colors=seriesColors(names);

  function dataFor(metric){const series={}; names.forEach(n=>series[n]=[]); srcSnaps.forEach(s=>{names.forEach(n=>{if(n==='Founders'){const F=s.results.founders||{}; series[n].push(parseNum(F[metric]));} else {const r=(s.results.investors||[]).find(x=>x.name===n)||{}; series[n].push(parseNum(r[metric]));}})}); return series;}
  function yRange(series,isPct=false){const flat=[]; names.forEach(n=>flat.push(...series[n])); let minV=Math.min(0,...flat),maxV=Math.max(isPct?0.01:0,...flat); if(minV===maxV){maxV=minV+1;} const pad=(maxV-minV)*0.1; return [minV-pad,maxV+pad];}
  function yMap(v,minV,maxV,H,P){return (H-P)-((v-minV)/(maxV-minV))*(H-2*P)}
  function xMap(i,n,W,P){return P+(n<=1?(W-2*P)/2:(i*(W-2*P)/(n-1)))}

  function drawLines(series,fmtY,isPct=false){
    const [minV,maxV]=yRange(series,isPct); drawAxes(ctx,W,H,P,minV,maxV,labels,fmtY);
    names.forEach(n=>{const vals=series[n]; ctx.strokeStyle=colors[n]; ctx.lineWidth=2; ctx.beginPath();
      vals.forEach((v,i)=>{const x=xMap(i,vals.length,W,P), y=yMap(v,minV,maxV,H,P); if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);});
      ctx.stroke(); if(vals.length===1){drawPoint(ctx,xMap(0,1,W,P),yMap(vals[0],minV,maxV,H,P),colors[n]);}
      legend.insertAdjacentHTML('beforeend',`<span class="lg"><span class="sw" style="background:${colors[n]}"></span>${n}</span>`);});
  }
  function drawBars(seriesKey,fmtY){
    const s=srcSnaps[srcSnaps.length-1]; const vals=[]; names.forEach(n=>{if(n==='Founders'){vals.push(parseNum(s.results.founders[seriesKey]||0));} else {const r=(s.results.investors||[]).find(x=>x.name===n)||{}; vals.push(parseNum(r[seriesKey]||0));}});
    const minV=Math.min(0,...vals),maxV=Math.max(0.01,...vals),pad=(maxV-minV)*0.1; drawAxes(ctx,W,H,P,minV-pad,maxV+pad,[new Date(s.ts).toLocaleDateString()],fmtY);
    const bw=(W-2*P)/Math.max(3,vals.length*1.6);
    vals.forEach((v,i)=>{const x=P+i*(bw*1.6); const y0=yMap(0,minV-pad,maxV+pad,H,P), y1=yMap(v,minV-pad,maxV+pad,H,P);
      ctx.fillStyle=colors[names[i]]; const top=Math.min(y0,y1), h=Math.abs(y1-y0); ctx.fillRect(x,top,bw,h);
      legend.insertAdjacentHTML('beforeend',`<span class="lg"><span class="sw" style="background:${colors[names[i]]}"></span>${names[i]}</span>`);});
  }

  if(type==='lineNet'){drawLines(dataFor('net'),v=>money(v),false); $('yAxisTitle').textContent='Net profit ($)'; $('xAxisTitle').textContent='Date'; $('chartNote').textContent='Net profit per class (current or snapshots).'; return;}
  if(type==='barNet'){drawBars('net',v=>money(v)); $('yAxisTitle').textContent='Net profit ($)'; $('xAxisTitle').textContent='Date'; $('chartNote').textContent='Net profit per class (latest snapshot).'; return;}
  if(type==='barBase'){drawBars('base',v=>money(v)); $('yAxisTitle').textContent='Base profit ($)'; $('xAxisTitle').textContent='Date'; $('chartNote').textContent='Base (time‑weighted) profit per class (latest snapshot).'; return;}
  if(type==='lineEnd'){drawLines(dataFor('end'),v=>money(v),false); $('yAxisTitle').textContent='End capital ($)'; $('xAxisTitle').textContent='Date'; $('chartNote').textContent='End capital per class over time.'; return;}
  if(type==='linePGP'){
    const series=dataFor('pgp'); const fmt=v=>( (v*100).toFixed(0)+'%' );
    const flat=[]; Object.values(series).forEach(a=>flat.push(...a)); let mn=Math.min(0,...flat), mx=Math.max(0.01,...flat); if(mn===mx){mx=mn+0.01;} const pad=(mx-mn)*0.1; mn-=pad; mx+=pad;
    drawAxes(ctx,W,H,P,mn,mx,labels,fmt);
    names.forEach(n=>{const vals=series[n]; ctx.strokeStyle=colors[n]; ctx.lineWidth=2; ctx.beginPath();
      vals.forEach((v,i)=>{const x=xMap(i,vals.length,W,P), y=(H-P)-((v-mn)/(mx-mn))*(H-2*P); if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);});
      ctx.stroke(); if(vals.length===1){const x=xMap(0,1,W,P), y=(H-P)-((vals[0]-mn)/(mx-mn))*(H-2*P); drawPoint(ctx,x,y,colors[n]);}
      legend.insertAdjacentHTML('beforeend',`<span class="lg"><span class="sw" style="background:${colors[n]}"></span>${n}</span>`);});
    $('yAxisTitle').textContent='PGP (period %)'; $('xAxisTitle').textContent='Date'; $('chartNote').textContent='PGP = Net profit × Days / Dollar‑days (time‑weighted).'; return;
  }
}

/* ---------- wire buttons ---------- */
$('btnReseed').addEventListener('click',()=>{seedInvestors(); recalc();});
$('btnRecalcTop').addEventListener('click',()=>{recalc();});
$('btnSaveSnap').addEventListener('click',()=>{const out=compute(false); saveSnapshot(out); renderHistory();});

/* ---------- keyboard ---------- */
document.addEventListener('keydown',(e)=>{if(e.key==='Enter'&&!e.ctrlKey&&!e.metaKey){e.preventDefault();resetSelection();} else if(e.key==='Escape'){resetSelection();} else if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){e.preventDefault();recalc();}});

/* ---------- auto-init ---------- */
function renderHistoryOnTab(){if(document.querySelector('.tab.active')?.dataset.tab==='history') renderHistory();}
function autoInit(){
  try{ $('winEnd').value=$('winEnd').value||todayISO(); seedInvestors(); $('seedMsg').textContent='Data seeded ✓'; setView('week'); recalc();
       setTimeout(()=>{const body=$('allocBody'); if(!body||body.children.length===0){recalc();}},120);
       renderHistoryOnTab();
  }catch(e){$('seedMsg').textContent='Seeding error: '+e.message;}
}
window.addEventListener('load', autoInit);

/* ---------- AI Assistant features ---------- */
async function performOCR(file) {
  const worker = Tesseract.createWorker({ logger: m => console.log(m) });
  await worker.load();
  await worker.loadLanguage('eng');
  await worker.initialize('eng');
  const { data: { text } } = await worker.recognize(file);
  await worker.terminate();
  return text;
}
$('btnOCR').addEventListener('click', async () => {
  const file = $('fileInput').files[0];
  if(!file){ alert('Please select an image file first.'); return; }
  if(!file.type.startsWith('image/')){ alert('Please select a valid image file.'); return; }
  $('ocrOutput').value = 'Processing...';
  try {
    const text = await performOCR(file);
    $('ocrOutput').value = text;
  } catch(error) {
    $('ocrOutput').value = `Error: ${error.message}`;
  }
});
function importOcrData(){
  const text = $('ocrOutput').value || '';
  if(text.trim()===''){ alert('No OCR text to import.'); return; }
  const importType = $('ocrImportType').value;
  let lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
  if(importType === 'investor'){
    const invName = ($('ocrInvestorName').value || '').trim();
    if(!invName){ alert('Please enter an investor name for importing investor data.'); return; }
    for(let line of lines){
      // Find date and amount in the line
      let dateMatch = line.match(/(\d{1,2}[\/\-]\d{1,2}(?:[\/\-]\d{2,4})?)/);
      let dateStr = dateMatch ? dateMatch[1] : '';
      let amountMatch = line.match(/([$]?\s*\d[\d,]*(?:\.\d+)?\s*[kKmM]?)/);
      let amtStr = amountMatch ? amountMatch[0] : '';
      if(!amtStr){ continue; }
      // Clean amount string
      amtStr = amtStr.replace(/[^0-9.kKmM\-\.]/g,''); // remove non-numeric except k,m,.,-
      let multiplier = 1;
      if(amtStr.toLowerCase().endsWith('k')){ multiplier = 1000; amtStr = amtStr.slice(0,-1); }
      if(amtStr.toLowerCase().endsWith('m')){ multiplier = 1000000; amtStr = amtStr.slice(0,-1); }
      let amountVal = parseFloat(amtStr.replace(/,/g,'')) * multiplier;
      if(isNaN(amountVal)){ continue; }
      // Format date to YYYY-MM-DD if possible
      if(dateStr){
        // if year missing, use year from start date
        if(!/^\d{4}$/.test(dateStr.slice(-4))){ 
          const defaultYear = new Date($('winStart').value || todayISO()).getFullYear();
          // ensure format mm/dd or mm-dd
          let parts = dateStr.replace(/-/g,'/').split('/');
          if(parts.length >= 2){
            let m = parts[0].padStart(2,'0'), d = parts[1].padStart(2,'0');
            dateStr = `${defaultYear}-${m}-${d}`;
          }
        } else {
          // dateStr has year (possibly 2 or 4 digits)
          let parts = dateStr.replace(/-/g,'/').split('/');
          if(parts.length === 3){
            let [m,d,y] = parts;
            if(y.length===2){ 
              // assume 20xx for 2-digit year
              y = (y >= '50' ? '19'+y : '20'+y);
            }
            m = m.padStart(2,'0'); d = d.padStart(2,'0');
            dateStr = `${y}-${m}-${d}`;
          }
        }
      } else {
        // If no date found, use today's date or skip
        dateStr = todayISO();
      }
      // Add investor row with parsed data
      addInvestor(invName);
      const tbody = $('invBody');
      const newRow = tbody.children[tbody.children.length - 1];
      newRow.querySelector('td:nth-child(2) input').value = dateStr;
      newRow.querySelector('td:nth-child(3) input').value = amountVal.toFixed(2);
    }
  } else if(importType === 'founder'){
    for(let line of lines){
      let dateMatch = line.match(/(\d{1,2}[\/\-]\d{1,2}(?:[\/\-]\d{2,4})?)/);
      let dateStr = dateMatch ? dateMatch[1] : '';
      let amountMatch = line.match(/([$]?\s*\d[\d,]*(?:\.\d+)?\s*[kKmM]?)/);
      let amtStr = amountMatch ? amountMatch[0] : '';
      if(!amtStr){ continue; }
      amtStr = amtStr.replace(/[^0-9.kKmM\-\.]/g,'');
      let multiplier = 1;
      if(amtStr.toLowerCase().endsWith('k')){ multiplier = 1000; amtStr = amtStr.slice(0,-1); }
      if(amtStr.toLowerCase().endsWith('m')){ multiplier = 1000000; amtStr = amtStr.slice(0,-1); }
      let amountVal = parseFloat(amtStr.replace(/,/g,'')) * multiplier;
      if(isNaN(amountVal)){ continue; }
      if(dateStr){
        if(!/^\d{4}$/.test(dateStr.slice(-4))){ 
          const defaultYear = new Date($('winStart').value || todayISO()).getFullYear();
          let parts = dateStr.replace(/-/g,'/').split('/');
          if(parts.length >= 2){
            let m = parts[0].padStart(2,'0'), d = parts[1].padStart(2,'0');
            dateStr = `${defaultYear}-${m}-${d}`;
          }
        } else {
          let parts = dateStr.replace(/-/g,'/').split('/');
          if(parts.length === 3){
            let [m,d,y] = parts;
            if(y.length===2){ y = (y >= '50' ? '19'+y : '20'+y); }
            m = m.padStart(2,'0'); d = d.padStart(2,'0');
            dateStr = `${y}-${m}-${d}`;
          }
        }
      } else {
        dateStr = todayISO();
      }
      addFounderRow(dateStr, amountVal.toFixed(2));
    }
  }
  recalc();
}
$('btnImportOCR').addEventListener('click', importOcrData);
$('btnExportPDF').addEventListener('click', () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text('Founders Fund — Time-Weighted Allocation Results', 14, 15);
  doc.autoTable({ html: '#allocTable', startY: 20 });
  doc.text('Fee Breakdown — Investors (Base Profit Fee)', 14, doc.lastAutoTable.finalY + 10);
  doc.autoTable({ html: '#feeTable', startY: doc.lastAutoTable.finalY + 15 });
  doc.text('Entry Fee Breakdown (to Founders)', 14, doc.lastAutoTable.finalY + 10);
  doc.autoTable({ html: '#entryTable', startY: doc.lastAutoTable.finalY + 15 });
  doc.text('Fees by Class', 14, doc.lastAutoTable.finalY + 10);
  doc.autoTable({ html: '#feeClassTable', startY: doc.lastAutoTable.finalY + 15 });
  doc.save('FoundersFundResults.pdf');
});
</script>
</body>
</html>
