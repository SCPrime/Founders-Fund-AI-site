<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Founders Fund — Time‑Weighted Split Calculator (AI‑enhanced)</title>
<style>
  :root{--bg:#0b0e14;--panel:#121720;--text:#e6edf3;--muted:#9aa4b2;--accent:#39d0d8;--warn:#ffb020;--bad:#ff6b6b;--good:#35c759;--line:#233047;--ink:#0f141c}
  html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:0}
  .wrap{max-width:1240px;margin:18px auto;padding:0 14px}
  .status{background:#0f141c;border:1px solid #223047;border-radius:10px;padding:10px 12px;margin-bottom:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .status .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
  .dot.ok{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
  h1{font-size:24px;margin:8px 0 12px;text-align:center}
  h2{font-size:18px;margin:16px 0 10px;color:#d7e0ea}
  .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .tab{background:#172133;border:1px solid #283753;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:600;color:#cfe2ff}
  .tab.active{background:#1b2433;color:#fff}
  .panel{background:var(--panel);border:1px solid #1f2937;border-radius:10px;padding:16px;margin:12px 0}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;align-items:end}
  label{font-size:12px;color:var(--muted)}
  input[type="number"],input[type="text"],input[type="date"],select,textarea{width:100%;background:#0f141c;color:#e6edf3;border:1px solid #263043;padding:9px 10px;border-radius:8px;font-size:14px;font-family:system-ui}
  .btn{background:#172133;color:#e6edf3;border:1px solid #283753;padding:9px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn:hover{border-color:#33507a}
  .small{font-size:12px;color:#cbd5e1}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #334155;color:#cbd5e1;margin:4px 8px 0 0}
  .tablewrap{width:100%;overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:14px;min-width:980px}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);vertical-align:top}
  th{color:#b6c2d1;font-weight:600;text-align:left;white-space:nowrap}
  .right{text-align:right;white-space:nowrap}
  .x{cursor:pointer;color:#8ab4ff}
  .namecell{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .badge{font-size:11px;border:1px solid #334155;border-radius:999px;padding:1px 6px;color:#cbd5e1}
  .warnbox{border:1px solid #635015;background:#2b2315;color:#f6e4b4;border-radius:8px;padding:8px 10px;margin-top:8px}
  .legend{margin-top:6px;display:flex;gap:12px;flex-wrap:wrap}
  .lg{display:inline-flex;align-items:center;gap:6px}
  .sw{width:12px;height:12px;border-radius:2px;display:inline-block}
  canvas{background:#0f141c;border:1px solid #253347;border-radius:8px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .muted{color:#9aa4b2}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .chip{border:1px solid #334155;background:#0f141c;border-radius:999px;padding:4px 8px;font-size:12px}
  #ocrCanvas{max-width:100%;display:block;margin-top:8px;background:#0b0e14;border-radius:8px;border:1px dashed #2a3b55}
  #cropHint{font-size:12px;color:#9aa4b2;margin-top:4px}
  .activeBtn{outline:2px solid var(--accent)}
  .detTbl td{vertical-align:middle}
  .clickable{cursor:pointer}
</style>

<!-- PDF libs (free, client-side) -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.3/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="status">
    <span class="dot ok"></span><b>Calculator ready.</b>
    <span id="seedMsg" class="small">Seeding defaults…</span>
    <button class="btn" id="btnReseed">Force re‑seed</button>
    <button class="btn" id="btnRecalcTop">Recalculate</button>
    <label class="small"><input type="checkbox" id="autoSave" checked> Auto‑save on Recalculate</label>
    <button class="btn" id="btnSaveSnap">Save snapshot now</button>
    <span class="small" id="calcTime"></span>
  </div>

  <h1>Founders Fund</h1>

  <div class="tabs">
    <div class="tab active" data-tab="calc">Calculator</div>
    <div class="tab" data-tab="history">History</div>
    <div class="tab" data-tab="charts">Charts</div>
    <div class="tab" data-tab="audit">Founders Audit</div>
    <div class="tab" data-tab="assistant">AI Assistant</div>
  </div>

  <!-- ===== CALCULATOR ===== -->
  <div class="panel" data-pane="calc">
    <h2>Allocation Settings</h2>
    <div class="grid">
      <div style="grid-column:span 3">
        <label>View</label>
        <div>
          <button id="viewWeek" class="btn" onclick="setView('week')">Week</button>
          <button id="viewMax" class="btn" onclick="setView('max')">Max</button>
        </div>
      </div>
      <div style="grid-column:span 3">
        <label>Allocation window — Start (inclusive)</label>
        <input id="winStart" type="date" value="2025-08-30"/>
      </div>
      <div style="grid-column:span 3">
        <label>Allocation window — End (inclusive)</label>
        <input id="winEnd" type="date"/>
      </div>
      <div style="grid-column:span 3">
        <label>Total Wallet Size at End of Window ($)</label>
        <input id="walletSize" type="number" step="0.01" value="0"/>
      </div>

      <div style="grid-column:span 3">
        <label>Realized profit this period (if wallet size = 0) ($)</label>
        <input id="realizedProfit" type="number" step="0.01" value="1500"/>
      </div>
      <div style="grid-column:span 3">
        <label>Moonbag <b>realized</b> this period ($)</label>
        <input id="moonbagReal" type="number" step="0.01" value="0"/>
      </div>
      <div style="grid-column:span 3">
        <label>Moonbag <b>unrealized</b> (valuation change) ($)</label>
        <input id="moonbagUnreal" type="number" step="0.01" value="0"/>
      </div>
      <div style="grid-column:span 3">
        <label>Include <b>unrealized</b> in Wallet identity?</label>
        <select id="includeUnreal">
          <option value="no" selected>No — track only</option>
          <option value="yes">Yes — include in identity</option>
        </select>
      </div>

      <div style="grid-column:span 3">
        <label>Moonbag founders share (%)</label>
        <input id="moonbagFounderPct" type="number" step="0.1" value="75"/>
      </div>
      <div style="grid-column:span 3">
        <label>Regular fund fee on investor base profit (%) → Founders</label>
        <input id="mgmtFeePct" type="number" step="0.1" value="20"/>
      </div>
      <div style="grid-column:span 3">
        <label>Entry fee on new investor capital (%) → Founders</label>
        <input id="entryFeePct" type="number" step="0.1" value="10"/>
      </div>
      <div style="grid-column:span 3">
        <label>Entry fee reduces investor credited capital?</label>
        <select id="feeReducesInvestor">
          <option value="yes" selected>Yes (net = gross × (1−fee))</option>
          <option value="no">No (investor credited full; fee outside)</option>
        </select>
      </div>

      <div style="grid-column:span 2">
        <label>Founders — count</label>
        <input id="founderCount" type="number" min="1" step="1" value="2"/>
      </div>
      <div style="grid-column:span 2">
        <label>Weekly draw per founder ($)</label>
        <input id="drawPerFounder" type="number" step="1" value="0"/>
      </div>
      <div style="grid-column:span 3">
        <label>Apply founders’ draws in this period?</label>
        <select id="applyDraws"><option value="no" selected>No</option><option value="yes">Yes</option></select>
      </div>
      <div style="grid-column:span 3">
        <label>Dominance lead margin (%) over largest investor</label>
        <input id="domLeadPct" type="number" step="0.1" value="0"/>
      </div>
      <div style="grid-column:span 1">
        <label>&nbsp;</label>
        <button class="btn" id="btnRecalc" onclick="recalc()">Recalculate</button>
      </div>
      <div style="grid-column:span 2">
        <label>&nbsp;</label>
        <button class="btn" id="btnSetComputed" onclick="setPoolToComputed()">Set Wallet = Computed</button>
      </div>
      <div style="grid-column:span 2">
        <label>&nbsp;</label>
        <button class="btn" id="btnAccumulate" onclick="accumulateToMax()">Accumulate this period → Max</button>
      </div>
      <div style="grid-column:span 1">
        <label>&nbsp;</label>
        <button class="btn" id="btnResetMax" onclick="resetMax()">Reset Max</button>
      </div>
    </div>

    <div class="small" style="margin-top:6px">
      Identity: <code>WalletEnd = Start + Contrib + BaseProfit + MoonbagRealized (+ Unrealized?) − Draws (if applied)</code>.
    </div>
    <div class="warnbox" id="consistencyBox" style="display:none">
      <b>Consistency check:</b> WalletEnd must be ≥ <span id="minWallet"></span> (= Start + Contrib − Draws?<span id="unrealTerm"></span> + MoonbagRealized).
      <button class="btn" style="margin-left:8px" onclick="setWalletToMin()">Set Wallet = minimum</button>
    </div>

    <div class="panel" style="margin-top:16px">
      <h2>Founders Contributions</h2>
      <div class="tablewrap">
        <table id="founderTable">
          <thead><tr><th style="width:35%">Date</th><th style="width:35%">Amount ($)</th><th>Action</th></tr></thead>
          <tbody id="founderBody">
            <tr>
              <td><input type="date" value="2025-07-10"/></td>
              <td><input type="number" step="0.01" value="5000"/></td>
              <td><span class="x" onclick="removeRow(this)">Remove</span></td>
            </tr>
          </tbody>
          <tfoot><tr><td colspan="3"><button class="btn" onclick="addFounderRow()">+ Add founder contribution</button></td></tr></tfoot>
        </table>
      </div>
      <div class="small">Investors’ entry & regular fund fees route to Founders. In <b>Max</b>, accumulated prior fees are added to founders’ capital (local only).</div>
    </div>

    <div class="panel">
      <h2>Investors & Contributions</h2>
      <div class="tablewrap">
        <table id="invTable">
          <thead>
            <tr>
              <th style="width:14%">Investor</th>
              <th style="width:18%">Date</th>
              <th style="width:18%">Amount ($)</th>
              <th style="width:18%">Gross→Net rule</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="invBody"></tbody>
          <tfoot>
            <tr><td colspan="5">
              <button class="btn" onclick="addInvestor()">+ Add investor</button>
              <button class="btn" onclick="addContribToSelected()">+ Add contribution to selected</button>
              <button class="btn" onclick="resetSelection()">Reset selection</button>
              <button class="btn" id="btnDefaults" onclick="resetToDefaults()">Reset to defaults</button>
            </td></tr>
          </tfoot>
        </table>
      </div>
      <div class="small" id="presetNote">Preset: Laura (7/22 $5k, 7/31 $5k, 8/25 $2.5k, 9/06 $2.5k); Damon (8/02 $5k). Fees: 10% entry, 20% regular fund fee on investor base profit only → Founders.</div>
    </div>

    <div class="panel">
      <h2>Audit — Row Classification</h2>
      <div id="auditBody" class="small"></div>
    </div>

    <div class="panel">
      <h2>Results (time‑weighted)</h2>
      <div id="kpis" class="small"></div>
      <div class="tablewrap">
        <table id="allocTable" style="margin-top:10px">
          <thead>
            <tr>
              <th>Class / Name</th>
              <th class="right">Start‑of‑window capital</th>
              <th class="right">Contribs in window</th>
              <th class="right">Dollar‑days (weight)</th>
              <th class="right">TW Share %</th>
              <th class="right">Base profit share</th>
              <th class="right">Regular fund fee (20%)</th>
              <th class="right">Moonbag (realized)</th>
              <th class="right">Draws</th>
              <th class="right">Net Profit (after fees)</th>
              <th class="right">PGP (period %)</th>
              <th class="right">End capital</th>
            </tr>
          </thead>
          <tbody id="allocBody"></tbody>
          <tfoot>
            <tr>
              <td><b>Totals</b></td>
              <td class="right" id="tStart">$0</td>
              <td class="right" id="tContrib">$0</td>
              <td class="right" id="tDD">$0</td>
              <td class="right" id="tTW">100%</td>
              <td class="right" id="tBase">$0</td>
              <td class="right" id="tFee">$0</td>
              <td class="right" id="tMoon">$0</td>
              <td class="right" id="tDraw">$0</td>
              <td class="right" id="tNet">$0</td>
              <td class="right" id="tPGP">—</td>
              <td class="right" id="tEnd">$0</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="small" id="domNote"></div>
    </div>

    <div class="panel">
      <h2>Fee Breakdown — Investors (base profit only)</h2>
      <div class="tablewrap">
        <table id="feeTable">
          <thead>
            <tr>
              <th>Investor</th>
              <th class="right">Base profit share</th>
              <th class="right">Fee rate</th>
              <th class="right">Fee amount</th>
            </tr>
          </thead>
          <tbody id="feeBody"></tbody>
          <tfoot>
            <tr>
              <td><b>Totals</b></td>
              <td class="right" id="feeBaseTotal">$0</td>
              <td class="right">—</td>
              <td class="right" id="feeAmtTotal">$0</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="small" id="feeNotes"></div>
    </div>

    <div class="panel">
      <h2>Entry Fee Breakdown — Routed to Founders (10%)</h2>
      <div class="tablewrap">
        <table id="entryTable">
          <thead>
            <tr>
              <th>Investor</th>
              <th class="right">Entry fees — Pre‑start</th>
              <th class="right">Entry fees — In window</th>
              <th class="right">Total entry fees</th>
            </tr>
          </thead>
          <tbody id="entryBody"></tbody>
          <tfoot>
            <tr>
              <td><b>Totals</b></td>
              <td class="right" id="entryPreTotal">$0</td>
              <td class="right" id="entryInTotal">$0</td>
              <td class="right" id="entryAllTotal">$0</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="small">Entry fees are capital transfers to Founders. Pre‑start fees increase founders’ start‑of‑window capital; in‑window fees count as founders’ in‑window contribution and affect dollar‑days immediately.</div>
    </div>

    <div class="panel">
      <h2>Fees by Class — Founders & Investors</h2>
      <div class="tablewrap">
        <table id="feeClassTable">
          <thead>
            <tr>
              <th>Class / Name</th>
              <th class="right">Base profit share</th>
              <th class="right">Mgmt fee role</th>
              <th class="right">Mgmt fee rate</th>
              <th class="right">Mgmt fee amount (±)</th>
              <th class="right">Entry fees this window (±)</th>
            </tr>
          </thead>
          <tbody id="feeClassBody"></tbody>
          <tfoot>
            <tr>
              <td><b>Totals</b></td>
              <td class="right" id="feeClassBaseTotal">$0</td>
              <td class="right">—</td>
              <td class="right">—</td>
              <td class="right" id="feeClassAmtTotal">$0</td>
              <td class="right" id="feeClassEntryWinTotal">$0</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="small">Founders receive investor fees; investors pay 20% of positive base shares; no fee on moonbag.</div>
    </div>

    <div class="panel">
      <h2>Diagnostics — Presence</h2>
      <div id="diagList" class="small"></div>
    </div>
  </div>

  <!-- ===== HISTORY ===== -->
  <div class="panel" data-pane="history" style="display:none">
    <h2>Saved Snapshots</h2>
    <div class="small">Snapshots are saved to your browser’s local storage. They include inputs and computed results (for charts).</div>
    <div id="histList" class="small" style="margin-top:10px"></div>
    <div class="hr"></div>
    <div>
      <button class="btn" onclick="exportHistory()">Export history</button>
      <input type="file" id="histFile" accept=".json" style="display:none"/>
      <button class="btn" onclick="document.getElementById('histFile').click()">Import history</button>
      <button class="btn" onclick="clearHistory()">Clear history</button>
    </div>
  </div>

  <!-- ===== CHARTS ===== -->
  <div class="panel" data-pane="charts" style="display:none">
    <h2>Charts</h2>
    <div class="grid" style="align-items:center">
      <div style="grid-column:span 4">
        <label>Data Source</label>
        <select id="chartSource">
          <option value="current">Current (on screen)</option>
          <option value="latest">Latest saved snapshot</option>
          <option value="all">All saved snapshots (time series)</option>
        </select>
      </div>
      <div style="grid-column:span 5">
        <label>Chart Type</label>
        <select id="chartType">
          <option value="lineNet">Line — Net profit (per class)</option>
          <option value="barNet">Bar — Net profit (per class)</option>
          <option value="barBase">Bar — Base profit (per class)</option>
          <option value="lineEnd">Line — End capital (per class)</option>
          <option value="linePGP">Line — PGP (period %, time‑weighted)</option>
        </select>
      </div>
      <div style="grid-column:span 2">
        <label>Include Founders in line charts?</label>
        <select id="chartInclF"><option value="yes" selected>Yes</option><option value="no">No</option></select>
      </div>
      <div style="grid-column:span 1">
        <label>&nbsp;</label>
        <button class="btn" onclick="drawChart()">Draw</button>
      </div>
    </div>
    <div style="margin-top:12px">
      <canvas id="chart" width="1100" height="420"></canvas>
      <div class="legend" id="legend"></div>
      <div class="small" id="chartNote"></div>
      <div class="small" style="margin-top:6px"><b id="yAxisTitle"></b> — Y‑axis · <b id="xAxisTitle"></b> — X‑axis</div>
    </div>
  </div>

  <!-- ===== AUDIT ===== -->
  <div class="panel" data-pane="audit" style="display:none">
    <h2>Founders Audit — Composition & Math</h2>
    <div id="auditFounders" class="small"></div>
  </div>

  <!-- ===== AI ASSISTANT ===== -->
  <div class="panel" data-pane="assistant" style="display:none">
    <h2>AI Assistant — Dense‑Text OCR with Pre‑mapped Detections</h2>

    <h3 style="margin:8px 0 6px;">1) Upload & Configure</h3>
    <div class="row">
      <input type="file" id="fileInput" accept="image/*"/>
      <button class="btn" id="btnOCR">Extract Text (multi‑pass)</button>
      <label class="chip"><input type="checkbox" id="chkEnhance" checked> Contrast boost</label>
      <label class="chip">Threshold <input type="range" id="thresh" min="150" max="240" value="205"></label>
      <label class="chip">Upscale <input type="range" id="scaleFactor" min="2" max="4" step="1" value="3"></label>
      <label class="chip">Row tiles <input type="range" id="tilesY" min="1" max="4" step="1" value="2"></label>
      <label class="chip">PSM
        <select id="psm">
          <option value="6" selected>6 — uniform block</option>
          <option value="4">4 — single column</option>
          <option value="7">7 — single line</option>
        </select>
      </label>
      <label class="chip"><input type="checkbox" id="chkMorph" checked> Thicken thin text</label>
      <label class="chip"><input type="checkbox" id="chkAutoTop" checked> Auto‑crop top <span id="autoTopPctLabel">(35%)</span></label>
      <input type="range" id="autoTopPct" min="10" max="50" value="35" style="width:160px">
      <label class="chip"><input type="checkbox" id="chkOverlay"> Show word boxes</label>
    </div>

    <div class="row" style="margin-top:6px">
      <button class="btn" id="btnDrawInclude">Draw include box</button>
      <button class="btn" id="btnDrawExclude">Draw exclude box</button>
      <button class="btn" id="btnAddDetection">Add detection (green)</button>
      <button class="btn" id="btnUndoBox">Undo last</button>
      <button class="btn" id="btnClearBoxes">Clear boxes</button>
      <span class="small muted">Tip: include over dense rows; exclude charts/avatars.</span>
    </div>

    <canvas id="ocrCanvas" width="0" height="0" class="clickable"></canvas>
    <div id="cropHint">After extraction, red dotted boxes show auto‑detected label→value pairs (click a red box to toggle keep/ignore). “Add detection” lets you draw your own and assign a field.</div>

    <div id="ocrOutputWrapper" style="margin-top:12px;">
      <label>Recognized Text (editable):</label>
      <textarea id="ocrOutput" rows="7" style="margin-top:4px;"></textarea>
    </div>
    <div class="small muted" style="margin-top:6px;">Runs locally via Tesseract.js (free). No API keys.</div>

    <div class="hr"></div>

    <h3 style="margin:8px 0 6px;">2) Verify Detections (click red boxes to toggle)</h3>
    <div class="tablewrap">
      <table class="detTbl" id="detTable">
        <thead><tr><th>Keep</th><th>Field</th><th>Label text</th><th>Detected value</th><th>Confidence</th></tr></thead>
        <tbody id="detBody"></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:8px;">
      <button class="btn" id="btnApplyDetections">Apply detections → fields</button>
      <button class="btn" id="btnParseTop">…or Parse from OCR Text</button>
    </div>

    <div class="hr"></div>

    <h3 style="margin:8px 0 6px;">2b) Parsed Metrics (editable before push)</h3>
    <div class="grid">
      <div style="grid-column:span 3"><label>Total Value ($)</label><input type="text" id="aiTotalValue" placeholder="$33,143.00"/></div>
      <div style="grid-column:span 3"><label>Unrealized PNL ($)</label><input type="text" id="aiUnrealized" placeholder="+$181.80"/></div>
      <div style="grid-column:span 3"><label>Realized PNL ($)</label><input type="text" id="aiRealized" placeholder="+$8,599.13"/></div>
      <div style="grid-column:span 3"><label>Available Balance ($)</label><input type="text" id="aiAvailable" placeholder="$—"/></div>
    </div>

    <div class="hr"></div>

    <h3 style="margin:8px 0 6px;">3) (Optional) Parse Contributions</h3>
    <div class="grid">
      <div style="grid-column:span 4">
        <label>Import as</label>
        <select id="ocrImportType">
          <option value="investor">Investor contributions</option>
          <option value="founder">Founder contributions</option>
        </select>
      </div>
      <div style="grid-column:span 5">
        <label>Investor Name (required if importing investor data)</label>
        <input type="text" id="ocrInvestorName" placeholder="Investor"/>
      </div>
      <div style="grid-column:span 3">
        <label>&nbsp;</label>
        <button class="btn" id="btnPreview">Preview Executive Report (no changes)</button>
      </div>
    </div>

    <div id="previewArea" class="panel small" style="display:none; margin-top:12px;">
      <div class="small muted">Preview (dry‑run). Use <b>Push to Calculator</b> to commit.</div>
      <div id="previewTables"></div>
      <div style="margin-top:10px;">
        <button class="btn" id="btnExportPreview">Export Preview PDF</button>
      </div>
    </div>

    <div class="hr"></div>

    <h3 style="margin:8px 0 6px;">4) Commit to Calculator (optional)</h3>
    <div class="row">
      <button class="btn" id="btnCommit">Push to Calculator</button>
      <span class="small muted">Writes parsed values into the Calculator and recalculates.</span>
    </div>

    <div class="hr"></div>

    <h3 style="margin:8px 0 6px;">5) Export from Calculator</h3>
    <div class="row">
      <button class="btn" id="btnExportPDF">Export Calculator PDF</button>
      <div class="small muted">Exports current Calculator tables.</div>
    </div>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const $=(id)=>document.getElementById(id);
function money(x){return '$'+Number(x||0).toLocaleString(undefined,{maximumFractionDigits:2})}
function pct(x){return (100*(x||0)).toFixed(2)+'%'}
function daysBetweenInclusive(d0,d1){const ms=(new Date(d1)-new Date(d0));return Math.floor(ms/86400000)+1}
function parseNum(v){const x=parseFloat(v);return isNaN(x)?0:x}
function todayISO(){const d=new Date();return d.toISOString().slice(0,10)}
function toAmount(s){if(!s)return 0; const v=parseFloat(String(s).replace(/[^0-9.\-]/g,'')); return isNaN(v)?0:v}
function normalizeOCRText(s){return (s||'').replace(/[\u2013\u2014]/g,'-').replace(/[§\$S]/g,'$').replace(/[lI|]/g,'1').replace(/[Oo]/g,'0').replace(/[,，]/g,',').replace(/—/g,'-')}

/* ---------- tabs ---------- */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(a=>a.classList.remove('active'));
    t.classList.add('active');
    const tab=t.dataset.tab;
    document.querySelectorAll('[data-pane]').forEach(p=>p.style.display=(p.dataset.pane===tab)?'block':'none');
    if(tab==='history') renderHistory();
  });
});

/* ---------- view ---------- */
let viewMode='week';
function setView(mode){viewMode=mode;$('viewWeek').classList.toggle('active',mode==='week');$('viewMax').classList.toggle('active',mode==='max');recalc();}

/* ---------- investor ops ---------- */
let selectedRow=null;
function resetSelection(){const tbody=$('invBody');[...tbody.children].forEach(r=>r.style.outline='none');selectedRow=null}
function removeRow(el){el.closest('tr').remove()}
function addInvestor(name='Investor'){
  const tbody=$('invBody'); const tr=document.createElement('tr');
  tr.onclick=()=>{selectedRow=tr;[...tbody.children].forEach(r=>r.style.outline='none');tr.style.outline='1px dashed #3b82f6'};
  tr.innerHTML=`<td><input type="text" value="${name}"/></td>
<td><input type="date" value="${todayISO()}"/></td>
<td><input type="number" step="0.01" value="0"/></td>
<td><select><option value="default" selected>Use global</option><option value="yes">Reduce investor by fee</option><option value="no">Fee outside (investor full)</option></select></td>
<td><span class="x" onclick="addContribInline(this)">+ Add</span> · <span class="x" onclick="removeRow(this)">Remove</span></td>`;
  tbody.appendChild(tr);
}
function addContribInline(el){
  const tr=el.closest('tr'); const clone=tr.cloneNode(true); clone.style.outline='none';
  const tbody=$('invBody');
  clone.onclick=()=>{selectedRow=clone;[...tbody.children].forEach(r=>r.style.outline='none');clone.style.outline='1px dashed #3b82f6'};
  clone.querySelector('td:nth-child(2) input').value=todayISO();
  clone.querySelector('td:nth-child(3) input').value='0';
  tbody.appendChild(clone);
}
function addContribToSelected(){ if(!selectedRow){alert('Click a row to select an investor first.');return;} addContribInline(selectedRow.querySelector('.x')); }
function resetToDefaults(){ $('invBody').innerHTML=''; seedInvestors(); recalc(); }
function addFounderRow(dateStr='',amt=''){const tr=document.createElement('tr');tr.innerHTML=`<td><input type="date" value="${dateStr||'2025-07-10'}"/></td><td><input type="number" step="0.01" value="${amt||'0'}"/></td><td><span class="x" onclick="removeRow(this)">Remove</span></td>`;$('founderBody').appendChild(tr)}

/* ---------- seeds ---------- */
function seedInvestors(){
  const tbody=$('invBody'); tbody.innerHTML='';
  function row(name,dateStr,amt){const tr=document.createElement('tr');tr.onclick=()=>{selectedRow=tr;[...tbody.children].forEach(r=>r.style.outline='none');tr.style.outline='1px dashed #3b82f6'};tr.innerHTML=`<td><input type="text" value="${name}"/></td><td><input type="date" value="${dateStr}"/></td><td><input type="number" step="0.01" value="${amt}"/></td><td><select><option value="default" selected>Use global</option><option value="yes">Reduce investor by fee</option><option value="no">Fee outside (investor full)</option></select></td><td><span class="x" onclick="addContribInline(this)">+ Add</span> · <span class="x" onclick="removeRow(this)">Remove</span></td>`;tbody.appendChild(tr)}
  row('Laura','2025-07-22','5000');
  row('Laura','2025-07-31','5000');
  row('Laura','2025-08-25','2500');
  row('Laura','2025-09-06','2500');
  row('Damon','2025-08-02','5000');
}

/* ---------- classify (audit text) ---------- */
function classifyRows(start,end){
  const feeReduceGlobal=$('feeReducesInvestor').value;
  const entryFee=parseNum($('entryFeePct').value)/100.0;
  const invRows=[...$('invBody').children];
  let lines=[];
  for(const r of invRows){
    const name=r.querySelector('td:nth-child(1) input').value.trim()||'Investor';
    const d=r.querySelector('td:nth-child(2) input').value;
    let aGross=parseNum(r.querySelector('td:nth-child(3) input').value);
    if(aGross<=0||!d)continue;
    const feeSel=r.querySelector('td:nth-child(4) select').value;
    const feeMode=(feeSel==='default')?feeReduceGlobal:feeSel;
    const aNet=(feeMode==='yes')?aGross*(1-entryFee):aGross;
    let status='';
    if(d<=start)status='Pre‑start → Start‑of‑window';
    else if(d>start&&d<=end)status='In‑window → Contribs in window';
    else status='Post‑end → ignored';
    lines.push(`${name} — $${aGross.toFixed(2)} on ${d} → ${status} — net counted: $${aNet.toFixed(2)}`);
  }
  return lines.join('<br/>');
}

/* ---------- max ledger ---------- */
const LS_MAX='ff_max_accum_v2m';
function loadMax(){try{return parseNum(localStorage.getItem(LS_MAX)||'0')}catch(e){return 0}}
function saveMax(v){try{localStorage.setItem(LS_MAX,String(v))}catch(e){}}
function resetMax(){saveMax(0);recalc()}
function accumulateToMax(){const out=compute(true);const add=out.feesToFounders_total;saveMax(loadMax()+add);recalc()}

/* ---------- founders gather ---------- */
function gatherFounders(start,end){
  const rows=[...document.querySelectorAll('#founderBody tr')];
  let startCap=0,contribInWin=0,dd=0;
  for(const r of rows){
    const d=r.querySelector('td:nth-child(1) input').value;
    const a=parseNum(r.querySelector('td:nth-child(2) input').value);
    if(a<=0||!d)continue;
    if(d<=start)startCap+=a;
    const inWinStart=d<start?start:d;
    if(inWinStart<=end){
      const days=daysBetweenInclusive(inWinStart,end);
      dd+=a*days;
      if(d>start&&d<=end)contribInWin+=a;
    }
  }
  return {startCap,contribInWin,dd};
}

/* ---------- compute ---------- */
function compute(dry=false){
  const start=$('winStart').value;
  const end=$('winEnd').value || todayISO();
  const totalDays=daysBetweenInclusive(start,end);

  const mgmtFee=parseNum($('mgmtFeePct').value)/100.0;
  const entryFee=parseNum($('entryFeePct').value)/100.0;
  const feeReduceGlobal=$('feeReducesInvestor').value;
  const moonbagFounderPct=parseNum($('moonbagFounderPct').value)/100.0;
  const moonbagReal=parseNum($('moonbagReal').value);
  const moonbagUnreal=parseNum($('moonbagUnreal').value);
  const includeUnreal=($('includeUnreal').value==='yes');
  const founderCount=Math.max(1,parseInt(parseNum($('founderCount').value)));
  const drawPer=parseNum($('drawPerFounder').value);
  const applyDraws=($('applyDraws').value==='yes');
  const drawTotal=applyDraws ? founderCount*drawPer : 0;
  const domLead=parseNum($('domLeadPct').value)/100.0;

  // Founders
  let f=gatherFounders(start,end);
  const maxLedger=(viewMode==='max')?loadMax():0;
  if(maxLedger>0){ f.startCap+=maxLedger; f.dd+=maxLedger*totalDays; }

  // Investors
  const invRows=[...$('invBody').children];
  let invMap=new Map(); let invDDsum=0; let entryFees_thisWin=0;
  let entryPreBy=new Map(), entryInBy=new Map();

  for(const r of invRows){
    const name=(r.querySelector('td:nth-child(1) input').value.trim()||'Investor');
    const d=r.querySelector('td:nth-child(2) input').value;
    let aGross=parseNum(r.querySelector('td:nth-child(3) input').value);
    if(aGross<=0||!d)continue;
    const feeSel=r.querySelector('td:nth-child(4) select').value;
    const feeMode=(feeSel==='default')?feeReduceGlobal:feeSel;
    const aNet=(feeMode==='yes')?aGross*(1-entryFee):aGross;
    const entryAmt=aGross*entryFee;

    if(!invMap.has(name))invMap.set(name,{name,startCap:0,contribInWin:0,dd:0,preStart:0});
    const rec=invMap.get(name);

    if(d<=start){ rec.startCap+=aNet; rec.preStart+=aNet; }
    const inWinStart=d<start?start:d;
    if(inWinStart<=end){
      const days=daysBetweenInclusive(inWinStart,end);
      rec.dd+=aNet*days; invDDsum+=aNet*days;
      if(d>start&&d<=end)rec.contribInWin+=aNet;

      // Founders get entry fees as capital, time‑weighted
      f.dd+=entryAmt*days;
      if(d<=start){ f.startCap+=entryAmt; entryPreBy.set(name,(entryPreBy.get(name)||0)+entryAmt); }
      if(d>start&&d<=end){ f.contribInWin=(f.contribInWin||0)+entryAmt; entryInBy.set(name,(entryInBy.get(name)||0)+entryAmt); entryFees_thisWin+=entryAmt; }
    }
    invMap.set(name,rec);
  }

  const totalDD=f.dd+invDDsum;
  const shareF=(totalDD>0)?(f.dd/totalDD):0;

  const invList_tmp=[]; invMap.forEach(v=>invList_tmp.push(v));
  const invStartSum=invList_tmp.reduce((s,x)=>s+x.startCap,0);
  const invContribSum=invList_tmp.reduce((s,x)=>s+x.contribInWin,0);
  const totalStartCap=f.startCap+invStartSum;
  const totalContribWin=(f.contribInWin||0)+invContribSum;

  const walletSize=parseNum($('walletSize').value);
  const minWallet=totalStartCap+totalContribWin-(drawTotal)+(moonbagReal)+(includeUnreal?moonbagUnreal:0);
  let profitCore=0;
  if(walletSize>0){
    profitCore=walletSize-totalStartCap-totalContribWin+drawTotal-moonbagReal-(includeUnreal?moonbagUnreal:0);
  }else{
    profitCore=parseNum($('realizedProfit').value);
  }

  // Base profit allocations
  const baseF=profitCore*shareF;
  const invList=[]; invMap.forEach(v=>invList.push(v));
  const baseI_each=invList.map(x=>profitCore*(totalDD>0?x.dd/totalDD:0));

  // Regular fee on investor base profit > 0
  const feeFromI_each=baseI_each.map(x=>x>0?x*mgmtFee:0);
  const feeFromI_total=feeFromI_each.reduce((s,x)=>s+x,0);

  // Moonbag realized split
  const moonF=moonbagReal*moonbagFounderPct;
  const moonI_total=moonbagReal-moonF;
  const moonI_each=invList.map(x=>invDDsum>0?moonI_total*(x.dd/invDDsum):0);

  // Net profits
  const netF=baseF+feeFromI_total+moonF-(drawTotal);
  const netI_each=invList.map((x,i)=>(baseI_each[i]-feeFromI_each[i])+moonI_each[i]);

  // End capitals
  const endF=f.startCap+(f.contribInWin||0)+netF;
  const endI_each=invList.map((x,i)=>x.startCap+x.contribInWin+netI_each[i]);
  const endSum=endF+endI_each.reduce((s,x)=>s+x,0);

  // Dominance
  const maxInvEnd=endI_each.length?Math.max(...endI_each):0;
  const reqF=maxInvEnd*(1+domLead);
  let domState='warn',domMsg='';
  if(endF>=reqF){domState='good';domMsg='Dominance OK';}
  else if(((f.startCap+(f.contribInWin||0)+baseF+feeFromI_total+moonF))>=reqF){domState='warn';domMsg='Reduce draw to maintain dominance.';}
  else{domState='bad';domMsg='Increase profit or reduce draws; founders below largest investor.';}

  const pgpF=(f.dd>0)?(netF*totalDays/f.dd):0;

  // Investor summary (+ entry fees detail)
  const invSummary=invList.map((x,i)=>({
    name:x.name, startCap:x.startCap, contribInWin:x.contribInWin, dd:x.dd,
    base:baseI_each[i], feeMgmt:feeFromI_each[i], moon:moonI_each[i],
    net:netI_each[i], end:endI_each[i],
    entryPre:(entryPreBy.get(x.name)||entryPreBy.get(x.name?.toLowerCase())||0),
    entryIn:(entryInBy.get(x.name)||entryInBy.get(x.name?.toLowerCase())||0),
    pgp:(x.dd>0)?(netI_each[i]*totalDays/x.dd):0
  }));

  const feesToFounders_total=entryFees_thisWin+feeFromI_total;

  return {start,end,totalDays,f,invList,invSummary,invDDsum,totalDD,shareF,
          totalStartCap,totalContribWin,profitCore,moonbagReal,moonbagUnreal,includeUnreal,
          moonF,baseF,baseI_each,feeFromI_each,feeFromI_total,moonI_total,moonI_each,
          netF,netI_each,endF,endI_each,endSum,domState,domMsg,reqF,maxInvEnd,drawTotal,
          feesToFounders_total,pgpF,walletSize,minWallet,mgmtFee,applyDraws};
}

/* ---------- recalc & render ---------- */
function recalc(){
  const start=$('winStart').value; const end=$('winEnd').value||todayISO();
  if(!start||!end){alert('Set allocation window dates.');return;}
  const out=compute(false);

  $('minWallet').textContent=money(out.minWallet);
  $('unrealTerm').textContent=(out.includeUnreal?' + Unrealized':'');
  const box=$('consistencyBox'); box.style.display=(out.walletSize>0 && out.walletSize<out.minWallet)?'block':'none';

  const k=$('kpis'); k.innerHTML='';
  const pill=(label,val)=>`<span class="pill"><b>${label}:</b> ${money(val)}</span>`;
  const investorsNet=out.netI_each.reduce((s,x)=>s+x,0);
  k.innerHTML=pill('Investors net profit (after fee)',investorsNet)
             +pill('Regular fund fee → Founders',out.feeFromI_total)
             +pill('Founders net profit (after fees & draws)',out.netF)
             +pill('Moonbag realized (total)',out.moonbagReal)
             +pill('Computed end pool',out.endSum);

  $('auditBody').innerHTML=classifyRows(start,end);

  const tb=$('allocBody'); tb.innerHTML='';
  const pgpFmt=v=> (isFinite(v)?(v*100).toFixed(2)+'%':'—');
  function row(nameHtml,sc,cw,dd,twp,bp,fee,moon,draw,net,pgpStr,endv){
    return `<tr><td>${nameHtml}</td>
      <td class="right">${money(sc)}</td><td class="right">${money(cw)}</td>
      <td class="right">${money(dd)}</td><td class="right">${twp}</td>
      <td class="right">${money(bp)}</td><td class="right">${money(fee)}</td>
      <td class="right">${money(moon)}</td><td class="right">${money(draw)}</td>
      <td class="right">${money(net)}</td><td class="right">${pgpStr}</td>
      <td class="right">${money(endv)}</td></tr>`;
  }
  const twF=(out.totalDD>0)?pct(out.f.dd/out.totalDD):'0.00%';
  const foundersHTML=`<div class="namecell"><span>Founders</span><span class="badge">Pre‑start: ${money(out.f.startCap)}</span></div>`;
  tb.insertAdjacentHTML('beforeend',row(foundersHTML,out.f.startCap,(out.f.contribInWin||0),out.f.dd,twF,out.baseF,out.feeFromI_total,out.moonF,out.drawTotal,out.netF,pgpFmt(out.pgpF),out.endF));

  const namesPresent=new Set(out.invSummary.map(r=>r.name.toLowerCase()));
  function inject(r){
    const twp=(out.totalDD>0)?pct(r.dd/out.totalDD):'0.00%';
    tb.insertAdjacentHTML('beforeend',row(
      `<div class="namecell"><span>${r.name}</span><span class="badge">Pre‑start: ${money(r.startCap)}</span></div>`,
      r.startCap,r.contribInWin,r.dd,twp,r.base,-r.feeMgmt,r.moon,0,r.net,pgpFmt(r.pgp),r.end));
  }
  out.invSummary.forEach(inject);
  if(!namesPresent.has('laura')) inject({name:'Laura',startCap:0,contribInWin:0,dd:0,base:0,feeMgmt:0,moon:0,net:0,pgp:0,end:0});
  if(!namesPresent.has('damon')) inject({name:'Damon',startCap:0,contribInWin:0,dd:0,base:0,feeMgmt:0,moon:0,net:0,pgp:0,end:0});

  $('tStart').textContent=money(out.totalStartCap);
  $('tContrib').textContent=money(out.totalContribWin);
  $('tDD').textContent=money(out.totalDD);
  $('tTW').textContent='100%';
  $('tBase').textContent=money(out.baseF+out.baseI_each.reduce((s,x)=>s+x,0));
  $('tFee').textContent=money(out.feeFromI_total);
  $('tMoon').textContent=money(out.moonbagReal);
  $('tDraw').textContent=money(out.drawTotal);
  $('tNet').textContent=money(out.netF+out.netI_each.reduce((s,x)=>s+x,0));
  $('tEnd').textContent=money(out.endSum);
  $('tPGP').textContent='—';

  $('domNote').innerHTML=`<b>Dominance:</b> Founders end = ${money(out.endF)}; Max investor end = ${money(Math.max(0,...out.invSummary.map(r=>r.end)))}; Required founders ≥ ${money(out.reqF)} — ${out.domMsg}`;

  // Fee Breakdown — investors
  const fb=$('feeBody'); fb.innerHTML=''; let baseTotal=0, feeTotal=0;
  out.invSummary.forEach(r=>{
    baseTotal+=r.base; feeTotal+=r.base>0?r.feeMgmt:0;
    fb.insertAdjacentHTML('beforeend',`<tr><td>${r.name}</td><td class="right">${money(r.base)}</td><td class="right">${(out.mgmtFee*100).toFixed(2)}%</td><td class="right">${money(r.base>0?r.feeMgmt:0)}</td></tr>`);
  });
  if(!namesPresent.has('laura')) fb.insertAdjacentHTML('beforeend', `<tr><td>Laura</td><td class="right">$0</td><td class="right">—</td><td class="right">$0</td></tr>`);
  if(!namesPresent.has('damon')) fb.insertAdjacentHTML('beforeend', `<tr><td>Damon</td><td class="right">$0</td><td class="right">—</td><td class="right">$0</td></tr>`);
  $('feeBaseTotal').textContent=money(baseTotal); $('feeAmtTotal').textContent=money(feeTotal);
  $('feeNotes').innerHTML='Fee applies to investor <b>base</b> profit only; no fee on moonbag realized/unrealized.';

  // Entry fees table
  const eb=$('entryBody'); eb.innerHTML=''; let preTot=0,inTot=0;
  const nameSet=new Set([...out.invSummary.map(r=>r.name)]);
  nameSet.add('Laura'); nameSet.add('Damon');
  nameSet.forEach(n=>{
    const pre = out.invSummary.find(r=>r.name===n)?.entryPre || 0;
    const inn = out.invSummary.find(r=>r.name===n)?.entryIn  || 0;
    preTot+=pre; inTot+=inn;
    eb.insertAdjacentHTML('beforeend', `<tr><td>${n}</td><td class="right">${money(pre)}</td><td class="right">${money(inn)}</td><td class="right">${money(pre+inn)}</td></tr>`);
  });
  $('entryPreTotal').textContent=money(preTot); $('entryInTotal').textContent=money(inTot); $('entryAllTotal').textContent=money(preTot+inTot);

  // Fees by class
  const fcb=$('feeClassBody'); fcb.innerHTML='';
  let clsBaseTotal=out.baseF, clsFeeTotal=out.feeFromI_total, entryWinTotal=inTot;
  fcb.insertAdjacentHTML('beforeend', `<tr>
    <td>Founders</td><td class="right">${money(out.baseF)}</td><td class="right">Receives</td><td class="right">—</td>
    <td class="right">${money(out.feeFromI_total)}</td><td class="right">${money(inTot)}</td></tr>`);
  out.invSummary.forEach(r=>{
    fcb.insertAdjacentHTML('beforeend', `<tr>
      <td>${r.name}</td><td class="right">${money(r.base)}</td>
      <td class="right">${r.base>0?'Pays':'No fee (≤0 base)'}</td>
      <td class="right">${r.base>0?parseNum($('mgmtFeePct').value).toFixed(2)+'%':'—'}</td>
      <td class="right">${money(- (r.base>0?r.feeMgmt:0))}</td>
      <td class="right">$0</td></tr>`);
    clsBaseTotal+=r.base; clsFeeTotal-= (r.base>0?r.feeMgmt:0);
  });
  $('feeClassBaseTotal').textContent=money(clsBaseTotal);
  $('feeClassAmtTotal').textContent=money(clsFeeTotal);
  $('feeClassEntryWinTotal').textContent=money(entryWinTotal);

  renderFoundersAudit(out);
  renderDiagnostics();

  if($('autoSave').checked){ saveSnapshot(out); }
  $('calcTime').textContent='Last calc: '+(new Date()).toLocaleTimeString();
}

/* ---------- founders audit ---------- */
function renderFoundersAudit(out){
  const A=$('auditFounders'); const shareF=(out.totalDD>0)?out.f.dd/out.totalDD:0;
  const pgpFmt=v=>(isFinite(v)?(v*100).toFixed(2)+'%':'—');
  A.innerHTML=`
    <div class="grid" style="grid-template-columns: 1fr 1fr; gap:6px">
      <div>Window</div><div class="right">${out.start} → ${out.end} (${out.totalDays} days)</div>
      <div>Founders start‑of‑window capital</div><div class="right">${money(out.f.startCap)}</div>
      <div>Founders contribs in window (incl. entry fees)</div><div class="right">${money(out.f.contribInWin||0)}</div>
      <div>Founders dollar‑days</div><div class="right">${money(out.f.dd)}</div>
      <div>Founders TW share</div><div class="right">${pct(shareF)}</div>
      <div>Base profit (by TW share)</div><div class="right">${money(out.baseF)}</div>
      <div>Mgmt fees received from investors</div><div class="right">${money(out.feeFromI_total)}</div>
      <div>Moonbag realized to founders</div><div class="right">${money(out.moonF)}</div>
      <div>Draws (applied?)</div><div class="right">${out.applyDraws?('-'+money(out.drawTotal)):'$0.00'}</div>
      <div><b>Net profit (founders)</b></div><div class="right"><b>${money(out.netF)}</b></div>
      <div><b>End capital (founders)</b></div><div class="right"><b>${money(out.endF)}</b></div>
      <div>PGP (period %, time‑weighted)</div><div class="right">${pgpFmt(out.pgpF)}</div>
      <div>Identity minimum WalletEnd check</div><div class="right">${money(out.minWallet)}</div>
    </div>`;
}

/* ---------- diagnostics ---------- */
function renderDiagnostics(){
  const checks=[
    ['winStart','Start date input'],['winEnd','End date input'],['walletSize','Wallet size input'],
    ['realizedProfit','Realized profit input'],['moonbagReal','Moonbag realized input'],
    ['moonbagUnreal','Moonbag unrealized input'],['includeUnreal','Include unrealized toggle'],
    ['moonbagFounderPct','Moonbag founders %'],['mgmtFeePct','Regular fund fee %'],
    ['entryFeePct','Entry fee %'],['feeReducesInvestor','Entry fee net rule toggle'],
    ['founderCount','Founders count'],['drawPerFounder','Weekly draw per founder'],
    ['applyDraws','Apply draws toggle'],['domLeadPct','Dominance lead %'],['founderBody','Founders table body'],['invBody','Investors table body'],
    ['auditBody','Audit panel'],['kpis','KPI bar'],['allocBody','Results body'],
    ['feeBody','Fee breakdown body'],['entryBody','Entry fee body'],['feeClassBody','Fee by Class body'],
    ['consistencyBox','Consistency box'],['btnRecalc','Recalculate button'],
    ['btnSetComputed','Set Wallet = Computed'],['btnAccumulate','Accumulate→Max'],['btnResetMax','Reset Max']
  ];
  const el=$('diagList'); el.innerHTML='';
  checks.forEach(([id,label])=>{
    const ok=!!$(id); el.insertAdjacentHTML('beforeend', `<div>${label} — <b style="color:${ok?'#8df59b':'#ff8a8a'}">${ok?'OK':'MISSING'}</b></div>`);
  });
}

/* ---------- history ---------- */
const LS_HIST='ff_hist_v2m';
function loadHistory(){try{return JSON.parse(localStorage.getItem(LS_HIST)||'[]')}catch(e){return []}}
function saveHistory(arr){try{localStorage.setItem(LS_HIST,JSON.stringify(arr))}catch(e){}}
function saveSnapshot(out){
  const snap={ts:new Date().toISOString(),
    inputs:{winStart:$('winStart').value,winEnd:$('winEnd').value||todayISO(),walletSize:parseNum($('walletSize').value),
      realizedProfit:parseNum($('realizedProfit').value),moonbagReal:parseNum($('moonbagReal').value),
      moonbagUnreal:parseNum($('moonbagUnreal').value),includeUnreal:$('includeUnreal').value,
      moonbagFounderPct:parseNum($('moonbagFounderPct').value),mgmtFeePct:parseNum($('mgmtFeePct').value),
      entryFeePct:parseNum($('entryFeePct').value),feeReducesInvestor:$('feeReducesInvestor').value,
      founderCount:parseNum($('founderCount').value),drawPerFounder:parseNum($('drawPerFounder').value),
      applyDraws:$('applyDraws').value,domLeadPct:parseNum($('domLeadPct').value)},
    results:{
      founders:{end:out.endF,net:out.netF,base:out.baseF,pgp:out.pgpF},
      investors: out.invSummary.map(r=>({name:r.name,end:r.end,net:r.net,base:r.base,pgp:r.pgp})),
      totals:{end:out.endSum}, start:out.start, end:out.end
    }};
  const arr=loadHistory(); arr.push(snap); saveHistory(arr);
}
function renderHistory(){
  const arr=loadHistory(); const list=$('histList'); list.innerHTML='';
  if(arr.length===0){ list.innerHTML='<i>No snapshots saved yet.</i>'; return; }
  arr.forEach((s,i)=>{
    list.insertAdjacentHTML('beforeend',`<div class="panel" style="padding:10px;margin:8px 0">
      <div><b>${new Date(s.ts).toLocaleString()}</b> · Window: ${s.results.start} → ${s.results.end} · End pool: ${money(s.results.totals.end)}
        <button class="btn" onclick="loadSnapshot(${i})">Load</button>
        <button class="btn" onclick="deleteSnapshot(${i})">Delete</button>
      </div></div>`);
  });
}
function loadSnapshot(i){
  const arr=loadHistory(); const s=arr[i]; if(!s)return;
  $('winStart').value=s.inputs.winStart; $('winEnd').value=s.inputs.winEnd;
  $('walletSize').value=s.inputs.walletSize; $('realizedProfit').value=s.inputs.realizedProfit;
  $('moonbagReal').value=s.inputs.moonbagReal; $('moonbagUnreal').value=s.inputs.moonbagUnreal;
  $('includeUnreal').value=s.inputs.includeUnreal;
  $('moonbagFounderPct').value=s.inputs.moonbagFounderPct;
  $('mgmtFeePct').value=s.inputs.mgmtFeePct; $('entryFeePct').value=s.inputs.entryFeePct;
  $('feeReducesInvestor').value=s.inputs.feeReducesInvestor;
  $('founderCount').value=s.inputs.founderCount; $('drawPerFounder').value=s.inputs.drawPerFounder;
  $('applyDraws').value=s.inputs.applyDraws || 'no';
  $('domLeadPct').value=s.inputs.domLeadPct;
  recalc();
}
function deleteSnapshot(i){const arr=loadHistory(); arr.splice(i,1); saveHistory(arr); renderHistory()}
function exportHistory(){const data=JSON.stringify(loadHistory(),null,2); const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(data); a.download='founders_fund_history.json'; a.click();}
$('histFile').addEventListener('change',(e)=>{const f=e.target.files[0]; if(!f)return; const rd=new FileReader(); rd.onload=()=>{try{const arr=JSON.parse(rd.result); saveHistory(arr); renderHistory();}catch(err){alert('Invalid JSON');}}; rd.readAsText(f);});
function clearHistory(){if(!confirm('Clear all snapshots?'))return; saveHistory([]); renderHistory()}

/* ---------- charts ---------- */
function seriesColors(names){const base=['#48b0f7','#f7a048','#9ad84b','#c17bff','#ff7b9c','#5ad1c9','#e2ff6f','#fcd34d','#60a5fa','#f472b6']; const map={}; names.forEach((n,i)=>map[n]=base[i%base.length]); return map;}
function drawAxes(ctx,W,H,P,minV,maxV,labels,fmt){
  ctx.clearRect(0,0,W,H); ctx.strokeStyle='#2b3b55'; ctx.lineWidth=1; const ticks=5; const step=(maxV-minV)/ticks; ctx.font='12px system-ui'; ctx.fillStyle='#9aa4b2';
  for(let i=0;i<=ticks;i++){const v=minV+i*step; const y=(H-P)-((v-minV)/(maxV-minV))*(H-2*P); ctx.beginPath(); ctx.moveTo(P,y); ctx.lineTo(W-P,y); ctx.stroke(); ctx.fillText(fmt(v),6,y-2);}
  const n=labels.length; if(n>0){const stepX=(W-2*P)/Math.max(1,n-1); for(let i=0;i<n;i++){const x=P+i*stepX; ctx.fillText(labels[i], x-18, H-8);}}
  ctx.strokeStyle='#3a4a6b'; ctx.strokeRect(P,P,W-2*P,H-2*P);
}
function drawPoint(ctx,x,y,color){ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();}
function drawChart(){
  const src=$('chartSource').value, type=$('chartType').value, includeF=($('chartInclF').value==='yes');
  const cv=$('chart'); const ctx=cv.getContext('2d'); const W=cv.width,H=cv.height,P=50;
  const legend=$('legend'); legend.innerHTML='';
  const srcSnaps=(()=>{
    if(src==='current'){const out=compute(false); return [{ts:new Date().toISOString(),inputs:{winStart:out.start,winEnd:out.end},results:{founders:{end:out.endF,net:out.netF,base:out.baseF,pgp:out.pgpF},investors:out.invSummary.map(r=>({name:r.name,end:r.end,net:r.net,base:r.base,pgp:r.pgp}))}}];}
    if(src==='latest'){const arr=loadHistory(); return arr.length?[arr[arr.length-1]]:[];}
    return loadHistory();
  })();
  if(srcSnaps.length===0){$('chartNote').textContent='No data to plot. Save snapshots or use Current source.'; ctx.clearRect(0,0,W,H); return;}

  const namesSet=new Set(); srcSnaps.forEach(s=>(s.results.investors||[]).forEach(r=>namesSet.add(r.name)));
  let names=Array.from(namesSet); if(includeF) names=['Founders',...names];
  const labels=(src==='all')?srcSnaps.map(s=>new Date(s.ts).toLocaleDateString()):srcSnaps.map((s,i)=>i===0?new Date(s.ts).toLocaleDateString():'');
  const colors=seriesColors(names);

  function dataFor(metric){const series={}; names.forEach(n=>series[n]=[]); srcSnaps.forEach(s=>{names.forEach(n=>{if(n==='Founders'){const F=s.results.founders||{}; series[n].push(parseNum(F[metric]));} else {const r=(s.results.investors||[]).find(x=>x.name===n)||{}; series[n].push(parseNum(r[metric]));}})}); return series;}
  function yRange(series,isPct=false){const flat=[]; names.forEach(n=>flat.push(...series[n])); let minV=Math.min(0,...flat),maxV=Math.max(isPct?0.01:0,...flat); if(minV===maxV){maxV=minV+1;} const pad=(maxV-minV)*0.1; return [minV-pad,maxV+pad];}
  function yMap(v,minV,maxV,H,P){return (H-P)-((v-minV)/(maxV-minV))*(H-2*P)}
  function xMap(i,n,W,P){return P+(n<=1?(W-2*P)/2:(i*(W-2*P)/(n-1)))}

  function drawLines(series,fmtY,isPct=false){
    const [minV,maxV]=yRange(series,isPct); drawAxes(ctx,W,H,P,minV,maxV,labels,fmtY);
    names.forEach(n=>{const vals=series[n]; ctx.strokeStyle=colors[n]; ctx.lineWidth=2; ctx.beginPath();
      vals.forEach((v,i)=>{const x=xMap(i,vals.length,W,P), y=yMap(v,minV,maxV,H,P); if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);});
      ctx.stroke(); if(vals.length===1){drawPoint(ctx,xMap(0,1,W,P),yMap(vals[0],minV,maxV,H,P),colors[n]);}
      legend.insertAdjacentHTML('beforeend',`<span class="lg"><span class="sw" style="background:${colors[n]}"></span>${n}</span>`);});
  }
  function drawBars(seriesKey,fmtY){
    const s=srcSnaps[srcSnaps.length-1]; const vals=[]; names.forEach(n=>{if(n==='Founders'){vals.push(parseNum(s.results.founders[seriesKey]||0));} else {const r=(s.results.investors||[]).find(x=>x.name===n)||{}; vals.push(parseNum(r[seriesKey]||0));}});
    const minV=Math.min(0,...vals),maxV=Math.max(0.01,...vals),pad=(maxV-minV)*0.1; drawAxes(ctx,W,H,P,minV-pad,maxV+pad,[new Date(s.ts).toLocaleDateString()],fmtY);
    const bw=(W-2*P)/Math.max(3,vals.length*1.6);
    vals.forEach((v,i)=>{const x=P+i*(bw*1.6); const y0=yMap(0,minV-pad,maxV+pad,H,P), y1=yMap(v,minV-pad,maxV+pad,H,P);
      ctx.fillStyle=colors[names[i]]; const top=Math.min(y0,y1), h=Math.abs(y1-y0); ctx.fillRect(x,top,bw,h);
      legend.insertAdjacentHTML('beforeend',`<span class="lg"><span class="sw" style="background:${colors[names[i]]}"></span>${names[i]}</span>`);});
  }

  if(type==='lineNet'){drawLines(dataFor('net'),v=>money(v),false); $('yAxisTitle').textContent='Net profit ($)'; $('xAxisTitle').textContent='Date'; $('chartNote').textContent='Net profit per class (current or snapshots).'; return;}
  if(type==='barNet'){drawBars('net',v=>money(v)); $('yAxisTitle').textContent='Net profit ($)'; $('xAxisTitle').textContent='Date'; $('chartNote').textContent='Net profit per class (latest snapshot).'; return;}
  if(type==='barBase'){drawBars('base',v=>money(v)); $('yAxisTitle').textContent='Base profit ($)'; $('xAxisTitle').textContent='Date'; $('chartNote').textContent='Base (time‑weighted) profit per class (latest snapshot).'; return;}
  if(type==='lineEnd'){drawLines(dataFor('end'),v=>money(v),false); $('yAxisTitle').textContent='End capital ($)'; $('xAxisTitle').textContent='Date'; $('chartNote').textContent='End capital per class over time.'; return;}
  if(type==='linePGP'){
    const series=dataFor('pgp'); const fmt=v=>( (v*100).toFixed(0)+'%' );
    const flat=[]; Object.values(series).forEach(a=>flat.push(...a)); let mn=Math.min(0,...flat), mx=Math.max(0.01,...flat); if(mn===mx){mx=mn+0.01;} const pad=(mx-mn)*0.1; mn-=pad; mx+=pad;
    drawAxes(ctx,W,H,P,mn,mx,labels,fmt);
    names.forEach(n=>{const vals=series[n]; ctx.strokeStyle=colors[n]; ctx.lineWidth=2; ctx.beginPath();
      vals.forEach((v,i)=>{const x=xMap(i,vals.length,W,P), y=(H-P)-((v-mn)/(mx-mn))*(H-2*P); if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);});
      ctx.stroke(); if(vals.length===1){const x=xMap(0,1,W,P), y=(H-P)-((vals[0]-mn)/(mx-mn))*(H-2*P); drawPoint(ctx,x,y,colors[n]);}
      legend.insertAdjacentHTML('beforeend',`<span class="lg"><span class="sw" style="background:${colors[n]}"></span>${n}</span>`);});
    $('yAxisTitle').textContent='PGP (period %)'; $('xAxisTitle').textContent='Date'; $('chartNote').textContent='PGP = Net profit × Days / Dollar‑days (time‑weighted).'; return;
  }
}

/* ---------- wire buttons ---------- */
$('btnReseed').addEventListener('click',()=>{seedInvestors(); recalc();});
$('btnRecalcTop').addEventListener('click',()=>{recalc();});
$('btnSaveSnap').addEventListener('click',()=>{const out=compute(false); saveSnapshot(out); renderHistory();});

/* ---------- keyboard ---------- */
document.addEventListener('keydown',(e)=>{if(e.key==='Enter'&&!e.ctrlKey&&!e.metaKey){e.preventDefault();resetSelection();} else if(e.key==='Escape'){resetSelection();} else if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){e.preventDefault();recalc();}});

/* ---------- auto-init ---------- */
function autoInit(){
  try{ $('winEnd').value=$('winEnd').value||todayISO(); seedInvestors(); $('seedMsg').textContent='Data seeded ✓'; setView('week'); recalc();
       setTimeout(()=>{const body=$('allocBody'); if(!body||body.children.length===0){recalc();}},120);
  }catch(e){$('seedMsg').textContent='Seeding error: '+e.message;}
}
window.addEventListener('load', autoInit);
</script>

<!-- ===== AI OCR: hi‑res, tiling, morph thickening, multi‑boxes, detections, push ===== -->
<script>
let imgEl=null, displayScale=1;
const canvas=$('ocrCanvas'), ctx=canvas.getContext('2d');

/* Fallback loader for tesseract.js (tries 3 CDNs) */
async function loadScript(url){
  return new Promise((res,rej)=>{const s=document.createElement('script');s.src=url;s.async=true;s.onload=()=>res();s.onerror=()=>rej(new Error('Failed '+url));document.head.appendChild(s);});
}
async function ensureTesseract(){
  if(window.Tesseract && window.Tesseract.recognize) return 'ok';
  const cdns=[
    'https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js',
    'https://unpkg.com/tesseract.js@2.1.5/dist/tesseract.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/2.1.5/tesseract.min.js'
  ];
  let lastErr=null;
  for(const u of cdns){ try{ await loadScript(u); if(window.Tesseract) return 'ok'; }catch(e){ lastErr=e; } }
  throw lastErr || new Error('Tesseract failed to load from all CDNs.');
}

/* Canvas sizing */
function fitToCanvas(w,h){
  const maxW=Math.min(1100, document.querySelector('.wrap').clientWidth-40);
  displayScale = Math.min(1, maxW / w);
  canvas.width = Math.round(w * displayScale);
  canvas.height = Math.round(h * displayScale);
}

/* Load image */
function loadImageFromFile(file){
  return new Promise((res,rej)=>{ const url=URL.createObjectURL(file); const img=new Image(); img.onload=()=>{URL.revokeObjectURL(url); res(img)}; img.onerror=rej; img.src=url; });
}

/* Boxes & drawing state */
let drawMode=null, draftBox=null;
let includeBoxes=[], excludeBoxes=[], detections=[], ocrWords=[];
let singleCrop=null; // used if no include boxes

function clampRect(r){
  let x=r.x, y=r.y, w=r.w, h=r.h;
  if(w<0){x+=w; w=-w} if(h<0){y+=h; h=-h}
  x=Math.max(0,Math.min(x,canvas.width-1));
  y=Math.max(0,Math.min(y,canvas.height-1));
  w=Math.max(1,Math.min(w,canvas.width-x));
  h=Math.max(1,Math.min(h,canvas.height-y));
  return {x,y,w,h};
}
function drawCanvas(){
  if(!imgEl){ ctx.clearRect(0,0,canvas.width,canvas.height); return; }
  ctx.drawImage(imgEl,0,0,canvas.width,canvas.height);
  ctx.save(); ctx.lineWidth=2; ctx.setLineDash([6,4]);
  includeBoxes.forEach(b=>{ctx.strokeStyle='#39d0d8'; ctx.fillStyle='rgba(57,208,216,.15)'; ctx.strokeRect(b.x,b.y,b.w,b.h); ctx.fillRect(b.x,b.y,b.w,b.h);});
  excludeBoxes.forEach(b=>{ctx.strokeStyle='#ff6b6b'; ctx.fillStyle='rgba(255,107,107,.18)'; ctx.strokeRect(b.x,b.y,b.w,b.h); ctx.fillRect(b.x,b.y,b.w,b.h);});
  if(singleCrop && includeBoxes.length===0){ ctx.strokeStyle='#6aa7ff'; ctx.strokeRect(singleCrop.x,singleCrop.y,singleCrop.w,singleCrop.h); }
  if(draftBox){ ctx.strokeStyle=(drawMode==='exclude')?'#ff6b6b':(drawMode==='addDet'?'#60d060':'#39d0d8'); ctx.setLineDash([2,2]); ctx.strokeRect(draftBox.x,draftBox.y,draftBox.w,draftBox.h); }
  ctx.restore();

  // word overlay if chosen
  if($('chkOverlay')?.checked && ocrWords.length){
    ctx.save(); ctx.strokeStyle='rgba(192,128,255,.9)'; ctx.lineWidth=1; ctx.setLineDash([3,3]);
    ocrWords.forEach(bb=>ctx.strokeRect(bb.x0,bb.y0,bb.x1-bb.x0,bb.y1-bb.y0));
    ctx.restore();
  }
  // detection overlays (red dotted; click to toggle keep)
  ctx.save(); ctx.lineWidth=2; ctx.setLineDash([4,4]);
  detections.forEach(d=>{
    ctx.strokeStyle = d.keep ? '#ff8080' : 'rgba(255,128,128,.35)';
    ctx.strokeRect(d.box.x0,d.box.y0,d.box.x1-d.box.x0,d.box.y1-d.box.y0);
  });
  ctx.restore();
}

/* Auto top crop */
function autoTopCrop(){
  if(!imgEl || !$('chkAutoTop').checked || includeBoxes.length>0) return;
  const pct=parseInt($('autoTopPct').value||'35',10)/100;
  singleCrop={x:0,y:0,w:canvas.width,h:Math.round(canvas.height*pct)};
  drawCanvas();
}
$('autoTopPct').addEventListener('input',()=>{$('autoTopPctLabel').textContent='('+$('autoTopPct').value+'%)'; autoTopCrop();});

/* Map display rect → native pixels */
function displayRectToNative(r){
  const x=Math.round(r.x/displayScale), y=Math.round(r.y/displayScale);
  const w=Math.round(r.w/displayScale), h=Math.round(r.h/displayScale);
  return {x,y,w,h};
}

/* Brightness & polarity helpers */
function measureBrightness(id){
  const d=id.data; let sum=0, n=d.length/4, hi=0, lo=0;
  for(let i=0;i<d.length;i+=4){
    const v=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
    sum+=v; if(v>220) hi++; else if(v<35) lo++;
  }
  return {avg:sum/n, hiRatio:hi/n, loRatio:lo/n};
}
function binarizeToBlackText(octx, off, {invert, threshold}){
  const id=octx.getImageData(0,0,off.width,off.height), d=id.data, T=threshold;
  for(let i=0;i<d.length;i+=4){
    const v=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
    let black;
    if(invert){ const inv=255-v; black = inv <= T ? 1 : 0; }
    else { black = v <= T ? 1 : 0; }
    const pix = black ? 0 : 255;
    d[i]=d[i+1]=d[i+2]=pix; d[i+3]=255;
  }
  octx.putImageData(id,0,0);
}
function lightDespeckle(octx,off){
  const id=octx.getImageData(0,0,off.width,off.height), d=id.data, w=off.width,h=off.height;
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      const idx=(y*w+x)*4;
      if(d[idx]===0){
        let n=0; for(let yy=-1;yy<=1;yy++)for(let xx=-1;xx<=1;xx++){ if(xx||yy){ if(d[((y+yy)*w+(x+xx))*4]===0) n++; } }
        if(n<=1){ d[idx]=d[idx+1]=d[idx+2]=255; }
      }
    }
  }
  octx.putImageData(id,0,0);
}
function morphThicken(octx,off){
  // 1px dilation of black pixels (makes thin fonts heavier)
  const id=octx.getImageData(0,0,off.width,off.height), d=id.data;
  const out=octx.createImageData(off.width,off.height), o=out.data, w=off.width,h=off.height;
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      let black=0;
      for(let yy=-1;yy<=1;yy++)for(let xx=-1;xx<=1;xx++){
        const X=x+xx, Y=y+yy; if(X<0||Y<0||X>=w||Y>=h) continue;
        const idx=(Y*w+X)*4; if(d[idx]===0) black=1;
      }
      const idx=(y*w+x)*4; const pix = black?0:255;
      o[idx]=o[idx+1]=o[idx+2]=pix; o[idx+3]=255;
    }
  }
  octx.putImageData(out,0,0);
}

/* Preprocess region with auto polarity + upscale + morph */
async function preprocessRegionNative(nx,ny,nw,nh){
  let scale=parseInt($('scaleFactor')?.value||'3',10); if(!isFinite(scale)||scale<2||scale>4) scale=3;
  if(nw<64 || nh<32){ return {off:null, meta:{nx,ny,nw,nh,reason:'region-too-small',scale}}; }
  const off=document.createElement('canvas'), octx=off.getContext('2d', { willReadFrequently: true });
  octx.imageSmoothingEnabled=false; // preserve sharp edges on upscaling
  off.width=nw*scale; off.height=nh*scale;
  octx.drawImage(imgEl,nx,ny,nw,nh,0,0,off.width,off.height);

  const id=octx.getImageData(0,0,off.width,off.height);
  const br=measureBrightness(id);
  const likelyDarkUI = br.avg < 140 || br.loRatio > 0.12;
  const likelyLightUI = br.avg > 160 || br.hiRatio > 0.15;

  const enhance = $('chkEnhance')?.checked !== false;
  if(enhance){
    const T = parseInt($('thresh')?.value||'205',10);
    if(likelyDarkUI){ binarizeToBlackText(octx,off,{invert:true, threshold:T}); }
    else if(likelyLightUI){ binarizeToBlackText(octx,off,{invert:false, threshold:Math.min(230, Math.max(120, T-40))}); }
    else { binarizeToBlackText(octx,off,{invert:true, threshold:T}); }
    lightDespeckle(octx,off);
    if($('chkMorph')?.checked) morphThicken(octx,off);
  }

  return {off, meta:{nx,ny,nw,nh,avg:br.avg,hi:br.hiRatio,lo:br.loRatio,scale}};
}
function maskExcludes(offCtx, meta){
  const {nx,ny,scale}=meta;
  excludeBoxes.forEach(b=>{
    const nb=displayRectToNative(b);
    const lx=(nb.x-nx)*scale, ly=(nb.y-ny)*scale, lw=nb.w*scale, lh=nb.h*scale;
    if(lw>0 && lh>0){ offCtx.fillStyle='#ffffff'; offCtx.fillRect(lx,ly,lw,lh); }
  });
}

/* OCR pass */
async function ocrOnce(off){
  const psm=parseInt($('psm')?.value||'6',10);
  const res = await Tesseract.recognize(off,'eng',{
    tessedit_pageseg_mode: psm,
    preserve_interword_spaces:'1'
  });
  return { text:(res.data?.text||'').trim(), words:(res.data?.words||[]) };
}

/* UI wiring: image + boxes */
$('fileInput').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  imgEl = await loadImageFromFile(f);
  fitToCanvas(imgEl.width, imgEl.height);
  includeBoxes=[]; excludeBoxes=[]; detections=[]; ocrWords=[]; singleCrop=null;
  drawCanvas();
  autoTopCrop();
});
canvas.addEventListener('mousedown',(e)=>{ if(!imgEl) return; const r=canvas.getBoundingClientRect(); draftBox={x:e.clientX-r.left,y:e.clientY-r.top,w:0,h:0}; drawCanvas(); });
canvas.addEventListener('mousemove',(e)=>{ if(!draftBox) return; const r=canvas.getBoundingClientRect(); draftBox.w=(e.clientX-r.left)-draftBox.x; draftBox.h=(e.clientY-r.top)-draftBox.y; drawCanvas(); });
canvas.addEventListener('mouseup',()=>{ if(!draftBox) return; const box=clampRect(draftBox); draftBox=null;
  if(drawMode==='include'){ includeBoxes.push(box); }
  else if(drawMode==='exclude'){ excludeBoxes.push(box); }
  else if(drawMode==='addDet'){ // manual detection
    const val = extractDigitsFromRect(box);
    const field = prompt('Assign field: total / unrealized / realized / available', 'total')||'total';
    const canonical = ['total','unrealized','realized','available'].includes(field.toLowerCase())?field.toLowerCase():'total';
    const id=Date.now()+Math.random();
    detections.push({id,keep:true,field:canonical,label:'(manual)',value:val||'',box:{x0:box.x,y0:box.y,x1:box.x+box.w,y1:box.y+box.h},score: val?0.7:0.3});
    renderDetTable();
  }
  else { singleCrop=box; }
  drawCanvas();
});
canvas.addEventListener('click',(e)=>{ // toggle detection keep/ignore
  const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
  for(const d of detections){
    if(x>=d.box.x0 && x<=d.box.x1 && y>=d.box.y0 && y<=d.box.y1){ d.keep=!d.keep; renderDetTable(); drawCanvas(); return; }
  }
});
$('btnDrawInclude').addEventListener('click',()=>{ drawMode=(drawMode==='include'?null:'include'); uiModeButtons(); });
$('btnDrawExclude').addEventListener('click',()=>{ drawMode=(drawMode==='exclude'?null:'exclude'); uiModeButtons(); });
$('btnAddDetection').addEventListener('click',()=>{ drawMode=(drawMode==='addDet'?null:'addDet'); uiModeButtons(); });
$('btnClearBoxes').addEventListener('click',()=>{ includeBoxes=[]; excludeBoxes=[]; singleCrop=null; drawCanvas(); });
$('btnUndoBox').addEventListener('click',()=>{ if(includeBoxes.length) includeBoxes.pop(); else if(excludeBoxes.length) excludeBoxes.pop(); else singleCrop=null; drawCanvas(); });
function uiModeButtons(){
  ['btnDrawInclude','btnDrawExclude','btnAddDetection'].forEach(id=>$(id).classList.remove('activeBtn'));
  if(drawMode==='include') $('btnDrawInclude').classList.add('activeBtn');
  if(drawMode==='exclude') $('btnDrawExclude').classList.add('activeBtn');
  if(drawMode==='addDet') $('btnAddDetection').classList.add('activeBtn');
}

/* Extract digits inside a display rect from current OCR word map */
function extractDigitsFromRect(dispRect){
  const xs=dispRect.x, ys=dispRect.y, xe=dispRect.x+dispRect.w, ye=dispRect.y+dispRect.h;
  const inside=ocrWords.filter(w=>w.x0>=xs && w.x1<=xe && w.y0>=ys && w.y1<=ye).map(w=>w.text).join(' ');
  const m=(inside.match(/[+\-]?\$?\s?\d[\d,]*(?:\.\d+)?/g)||[]).join(' ').trim();
  return m || inside.trim();
}

/* MAIN: multi‑pass extract (tiling + auto polarity + fallback) */
$('btnOCR').addEventListener('click', async ()=>{
  try{
    $('ocrOutput').value='Initializing OCR engine…';
    await ensureTesseract();

    const regions=[];
    if(includeBoxes.length){ includeBoxes.forEach(b=>regions.push(b)); }
    else if(singleCrop){ regions.push(singleCrop); }
    else { const pct=parseInt($('autoTopPct').value||'35',10)/100; regions.push({x:0,y:0,w:canvas.width,h:Math.round(canvas.height*pct)}); }

    let combinedText='', wordsAccum=[];
    const tilesY = Math.max(1, Math.min(4, parseInt($('tilesY').value||'2',10)));
    for(const r of regions){
      const n=displayRectToNative(r);
      if(n.w<64 || n.h<32){ combinedText+='\n'; continue; }

      // Optional tiling: split region into horizontal stripes to improve line focus
      const tileH = Math.floor(n.h / tilesY);
      for(let ty=0; ty<tilesY; ty++){
        const ny = (ty===tilesY-1 ? n.y + ty*tileH : n.y + ty*tileH);
        const nh = (ty===tilesY-1 ? n.y + n.h - ny : tileH);
        $('ocrOutput').value=`Preprocessing ${n.w}×${nh} (tile ${ty+1}/${tilesY})…`;

        const prep=await preprocessRegionNative(n.x,ny,n.w,nh);
        if(!prep.off){ combinedText+='\n'; continue; }
        const octx=prep.off.getContext('2d'); maskExcludes(octx, prep.meta);

        // Pass 1
        $('ocrOutput').value=`OCR pass 1… (${n.w}×${nh})`;
        let {text, words} = await ocrOnce(prep.off);

        // Fallback: retry opposite polarity if tiny text
        if(text.replace(/\s+/g,'').length<6){
          $('ocrOutput').value='Low text; retrying opposite polarity…';
          octx.imageSmoothingEnabled=false;
          octx.drawImage(imgEl, n.x, ny, n.w, nh, 0, 0, prep.off.width, prep.off.height);
          const T=parseInt($('thresh')?.value||'205',10);
          const flipToLight = (prep.meta.avg < 140);
          if(flipToLight){ binarizeToBlackText(octx, prep.off, {invert:false, threshold:Math.min(230, Math.max(120, T-40))}); }
          else { binarizeToBlackText(octx, prep.off, {invert:true, threshold:T}); }
          lightDespeckle(octx,prep.off);
          if($('chkMorph')?.checked) morphThicken(octx,prep.off);
          const pass2=await ocrOnce(prep.off);
          if(pass2.text.replace(/\s+/g,'').length > text.replace(/\s+/g,'').length){ text=pass2.text; words=pass2.words; }
        }

        combinedText += (text||'')+'\n';
        // Map word boxes to display coords
        const scale=prep.meta.scale||3;
        wordsAccum.push(...words.map(w=>{
          return {
            text:w.text||'',
            x0:(n.x + w.bbox.x0/scale)*displayScale,
            y0:(ny  + w.bbox.y0/scale)*displayScale,
            x1:(n.x + w.bbox.x1/scale)*displayScale,
            y1:(ny  + w.bbox.y1/scale)*displayScale
          };
        }));
      }
      combinedText+='---\n';
    }
    ocrWords=wordsAccum;
    $('ocrOutput').value=normalizeOCRText(combinedText.trim() || '(No text recognized — enlarge include box, raise threshold to ~220, or capture in light mode).');

    // Pre‑mapped detections
    runDetections();
    renderDetTable();
    drawCanvas();
  }catch(err){
    $('ocrOutput').value='Error: '+(err && err.message ? err.message : String(err));
  }
});

/* ===== Pre‑mapped detections: label → right‑side money ===== */
const FIELD_OPTS=['total','unrealized','realized','available'];
const FIELD_LABEL={total:'Total Value',unrealized:'Unrealized PNL',realized:'Realized PNL',available:'Available Balance'};
const LABEL_PATTERNS={
  total:[/\btotal\s*(value|balance)?\b/i,/\bportfolio\b/i,/\bbalance\b(?!.*(real|unreal))/i],
  unrealized:[/\bunreal/i,/\bun\-?real/i],
  realized:[/\brealiz/i],
  available:[/\bavailable\b.*\b(balance|cash)?\b/i]
};
function runDetections(){
  detections=[]; if(ocrWords.length===0) return;
  // group words by row
  const rows=[]; ocrWords.forEach(w=>{ const yc=(w.y0+w.y1)/2; let row=rows.find(r=>Math.abs(r.yc-yc)<=16); if(!row){ row={yc,words:[]}; rows.push(row);} row.words.push(w);});
  rows.sort((a,b)=>a.yc-b.yc); rows.forEach(r=>r.words.sort((a,b)=>a.x0-b.x0));
  function rowText(r){return r.words.map(w=>w.text).join(' ');}
  function joinRightMoney(words,startX){
    const seq=[]; for(const w of words){ if(w.x0<=startX) continue; if(/[A-Za-z]/.test(w.text) && !/[$%]/.test(w.text)) continue; seq.push(w); }
    if(seq.length===0) return {text:'',box:null};
    const txt=seq.slice(0,6).map(w=>w.text).join(' ');
    const m=(txt.match(/[+\-]?\$?\s?\d[\d,]*(?:\.\d+)?/g)||[])[0] || txt;
    const b={x0:seq[0].x0,y0:Math.min(...seq.map(w=>w.y0)),x1:(seq[Math.min(seq.length-1,3)].x1),y1:Math.max(...seq.map(w=>w.y1))};
    return {text:m,box:b};
  }
  function matchLabel(text,field){ return LABEL_PATTERNS[field].some(rx=>rx.test(text)); }
  rows.forEach((r,idx)=>{
    const t=rowText(r);
    for(const field of FIELD_OPTS){
      if(matchLabel(t,field)){
        const lastLabelWord = r.words.filter(w=>/\w/.test(w.text)).slice(-1)[0] || r.words[r.words.length-1];
        const val = joinRightMoney(r.words, lastLabelWord?lastLabelWord.x1:(r.words[0]?.x0||0));
        if(val.text && /[0-9]/.test(val.text)){
          detections.push({id:Date.now()+Math.random(), keep:true, field, label:FIELD_LABEL[field], value:val.text, box:val.box, score:0.9});
        }else if(rows[idx+1]){ // try next row
          const val2=joinRightMoney(rows[idx+1].words, (rows[idx+1].words[0]?.x0||0)-1);
          if(val2.text && /[0-9]/.test(val2.text)){
            detections.push({id:Date.now()+Math.random(), keep:true, field, label:FIELD_LABEL[field], value:val2.text, box:val2.box, score:0.8});
          }
        }
      }
    }
  });
  // fallback for total
  if(!detections.some(d=>d.field==='total')){
    const all=ocrWords.map(w=>w.text).join(' ');
    const hits=(all.match(/[+\-]?\$?\s?\d{1,3}(?:[,\s]?\d{3})*(?:\.\d+)?/g)||[]);
    if(hits.length){
      const best=hits.sort((a,b)=>toAmount(b)-toAmount(a))[0];
      detections.push({id:Date.now()+Math.random(), keep:true, field:'total', label:'(fallback)', value:best, box:{x0:10,y0:10,x1:210,y1:44}, score:0.5});
    }
  }
}
function renderDetTable(){
  const tb=$('detBody'); tb.innerHTML='';
  detections.forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="checkbox" ${d.keep?'checked':''} data-id="${d.id}"></td>
      <td><select data-id="${d.id}">${FIELD_OPTS.map(f=>`<option value="${f}" ${f===d.field?'selected':''}>${FIELD_LABEL[f]}</option>`).join('')}</select></td>
      <td contenteditable="true" data-id="${d.id}" data-k="label">${d.label}</td>
      <td contenteditable="true" data-id="${d.id}" data-k="value">${d.value}</td>
      <td class="small">${(d.score*100|0)}%</td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('input[type="checkbox"]').forEach(ch=>ch.addEventListener('change',e=>{const id=e.target.dataset.id; const d=detections.find(x=>String(x.id)===String(id)); if(d){d.keep=e.target.checked; drawCanvas();}}));
  tb.querySelectorAll('select').forEach(sel=>sel.addEventListener('change',e=>{const id=e.target.dataset.id; const d=detections.find(x=>String(x.id)===String(id)); if(d){d.field=e.target.value;}}));
  tb.querySelectorAll('[contenteditable]').forEach(cell=>cell.addEventListener('input',e=>{const id=e.target.dataset.id, k=e.target.dataset.k; const d=detections.find(x=>String(x.id)===String(id)); if(d){d[k]=e.target.textContent.trim();}}));
}

/* Apply detections to AI metric fields */
$('btnApplyDetections').addEventListener('click',()=>{
  function pick(field){ const c=detections.filter(d=>d.keep && d.field===field); if(!c.length) return ''; c.sort((a,b)=>b.score-a.score); return c[0].value; }
  const total=pick('total'), un=pick('unrealized'), rl=pick('realized'), av=pick('available');
  if(total) $('aiTotalValue').value=total;
  if(un) $('aiUnrealized').value=un;
  if(rl) $('aiRealized').value=rl;
  if(av) $('aiAvailable').value=av;
  if(!total && !un && !rl && !av) alert('No detections kept. Click red boxes to keep, or “Add detection”.');
});

/* Fallback parser from OCR text */
function parseTopPanelText(text){
  const body=normalizeOCRText(text||'');
  const moneyRE=/[+\-]?\s?\$?\s?\d{1,3}(?:[,\s]?\d{3})*(?:\.\d+)?/g;
  function nearestAfter(rx){ const idx=body.search(rx); if(idx<0) return ''; const sl=body.slice(idx,idx+200); const hit=sl.match(moneyRE); if(hit&&hit.length) return hit[0]; const pre=body.slice(Math.max(0,idx-100),idx); const preHit=pre.match(moneyRE); return preHit?preHit[preHit.length-1]:''; }
  let total=nearestAfter(/total\s*(value|balance)/i) || nearestAfter(/\bbalance\b(?!.*(real|unreal))/i);
  let unreal=nearestAfter(/\bunreal/i);
  let real=nearestAfter(/\brealiz/i);
  let avail=nearestAfter(/\bavailable\b/i);
  if(!total){ const all=(body.match(moneyRE)||[]); if(all.length) total=all.sort((a,b)=>toAmount(b)-toAmount(a))[0]; }
  return {total,unrealized:unreal,realized:real,available:avail};
}
$('btnParseTop').addEventListener('click',()=>{
  const text=$('ocrOutput').value||''; const m=parseTopPanelText(text);
  if(m.total) $('aiTotalValue').value=m.total;
  if(m.unrealized) $('aiUnrealized').value=m.unrealized;
  if(m.realized) $('aiRealized').value=m.realized;
  if(m.available) $('aiAvailable').value=m.available;
  if(!m.total && !m.unrealized && !m.realized && !m.available){
    alert('No recognizable metrics found. Increase Threshold, expand include box, or add a detection.');
  }
});

/* Preview / commit / export wiring (uses Calculator DOM) */
function snapshotState(){return{invHTML:$('invBody')?.innerHTML||'', founderHTML:$('founderBody')?.innerHTML||'', vals:{walletSize:$('walletSize')?.value||'', realizedProfit:$('realizedProfit')?.value||'', moonbagReal:$('moonbagReal')?.value||'', moonbagUnreal:$('moonbagUnreal')?.value||'', includeUnreal:$('includeUnreal')?.value||'no'}}}
function restoreState(s){ if($('invBody')) $('invBody').innerHTML=s.invHTML; if($('founderBody')) $('founderBody').innerHTML=s.founderHTML; if($('walletSize')) $('walletSize').value=s.vals.walletSize; if($('realizedProfit')) $('realizedProfit').value=s.vals.realizedProfit; if($('moonbagReal')) $('moonbagReal').value=s.vals.moonbagReal; if($('moonbagUnreal')) $('moonbagUnreal').value=s.vals.moonbagUnreal; if($('includeUnreal')) $('includeUnreal').value=s.vals.includeUnreal; recalc(); }
function applyTopPanelToDOM(){
  const total=toAmount($('aiTotalValue').value), un=toAmount($('aiUnrealized').value), rl=toAmount($('aiRealized').value);
  if(total>0 && $('walletSize')) $('walletSize').value=total.toFixed(2);
  if(!isNaN(un) && un!==0 && $('moonbagUnreal')) $('moonbagUnreal').value=un.toFixed(2);
  if(!isNaN(rl) && rl!==0 && $('realizedProfit')) $('realizedProfit').value=rl.toFixed(2);
}
function parseContribLines(text, type, investorName){
  const lines=(normalizeOCRText(text)||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const items=[];
  for(const line of lines){
    let date=(line.match(/(\d{1,2}[\/\-]\d{1,2}(?:[\/\-]\d{2,4})?)/)||[''])[0];
    let amtStr=(line.match(/([$]?\s*\d[\d,]*(?:\.\d+)?\s*[kKmM]?)/)||[''])[0]; if(!amtStr) continue;
    amtStr=amtStr.replace(/[^0-9.kKmM\-\.]/g,''); let mult=1;
    if(amtStr.toLowerCase().endsWith('k')){mult=1000; amtStr=amtStr.slice(0,-1);}
    if(amtStr.toLowerCase().endsWith('m')){mult=1_000_000; amtStr=amtStr.slice(0,-1);}
    const amt=parseFloat(amtStr.replace(/,/g,''))*mult; if(!isFinite(amt)) continue;
    if(!date) date=todayISO(); items.push({type,investor:investorName||'Investor',date,amount:amt});
  }
  return items;
}
function applyContribsToDOM(items){
  const tbody=$('invBody'), fbody=$('founderBody'); if(!tbody||!fbody) return;
  function addFounder(date,amt){const tr=document.createElement('tr');tr.innerHTML=`<td><input type="date" value="${date}"/></td><td><input type="number" step="0.01" value="${amt}"/></td><td><span class="x">Remove</span></td>`;fbody.appendChild(tr)}
  function addInvestorRow(name,date,amt){const tr=document.createElement('tr');tr.innerHTML=`<td><input type="text" value="${name}"/></td><td><input type="date" value="${date}"/></td><td><input type="number" step="0.01" value="${amt}"/></td><td><select><option value="default" selected>Use global</option><option value="yes">Reduce investor by fee</option><option value="no">Fee outside (investor full)</option></select></td><td><span class="x">+ Add</span> · <span class="x">Remove</span></td>`;tbody.appendChild(tr)}
  for(const it of items){ if(it.type==='investor') addInvestorRow(it.investor,it.date,it.amount.toFixed(2)); else addFounder(it.date,it.amount.toFixed(2)); }
}
function buildPreviewTables(){ const holder=$('previewTables'); holder.innerHTML='Preview generated from a dry‑run calculator recalc.'; $('previewArea').style.display='block'; }

$('btnPreview').addEventListener('click',()=>{
  const text=$('ocrOutput').value||''; const type=$('ocrImportType').value; const name=$('ocrInvestorName').value||'Investor';
  const autoWas=$('autoSave')?.checked; if($('autoSave')) $('autoSave').checked=false;
  const snap=snapshotState();
  try{ applyTopPanelToDOM(); const items=parseContribLines(text,type,name); applyContribsToDOM(items); recalc(); buildPreviewTables(); }
  finally{ restoreState(snap); if($('autoSave')) $('autoSave').checked=autoWas; }
});
$('btnCommit').addEventListener('click',()=>{
  const text=$('ocrOutput').value||''; const type=$('ocrImportType').value; const name=$('ocrInvestorName').value||'Investor';
  applyTopPanelToDOM(); const items=parseContribLines(text,type,name); applyContribsToDOM(items); recalc(); alert('Applied to Calculator and recalculated.');
});
$('btnExportPreview').addEventListener('click',()=>{
  const { jsPDF } = window.jspdf; const doc=new jsPDF(); doc.setFontSize(12);
  doc.text('Founders Fund — Executive Report (Preview)',14,15);
  doc.text('Exported from AI preview. Use Calculator export for full tables.',14,23);
  doc.save('FoundersFund_Preview.pdf');
});
$('btnExportPDF').addEventListener('click',()=>{
  const { jsPDF } = window.jspdf; const doc=new jsPDF(); doc.setFontSize(12);
  doc.text('Founders Fund — Calculator Export',14,15);
  doc.text('This export includes the currently visible calculator tables.',14,23);
  doc.save('FoundersFund_Calculator.pdf');
});
</script>
</body>
</html>
